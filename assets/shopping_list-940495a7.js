import{w as m,h as Xs,x as Js,k as Zs,e as Me,y as er,_ as tr,C as nr,b as Un,z as V,A as an,B as le,D as ir,G as sr,H as rr,I as Pe,J as _t,L as or,K as nt,M as cn,l as lr,N as wi,O as un,P as ar,Q as cr,v as Hn,i as Si,a as ur,p as hr,R as Nt,T as dr,S as fr,U as _r,V as pr}from"./main-90cbe5f5.js";import{a as gr,b as ht,N as Vn}from"./index-e3d5d3f4-e17588f4.js";var jt={},mr={get exports(){return jt},set exports(n){jt=n}};(function(n,e){(function(i,s){n.exports=s()})(window,function(){return function(t){var i={};function s(r){if(i[r])return i[r].exports;var o=i[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,s),o.l=!0,o.exports}return s.m=t,s.c=i,s.d=function(r,o,l){s.o(r,o)||Object.defineProperty(r,o,{enumerable:!0,get:l})},s.r=function(r){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})},s.t=function(r,o){if(o&1&&(r=s(r)),o&8||o&4&&typeof r=="object"&&r&&r.__esModule)return r;var l=Object.create(null);if(s.r(l),Object.defineProperty(l,"default",{enumerable:!0,value:r}),o&2&&typeof r!="string")for(var c in r)s.d(l,c,function(a){return r[a]}.bind(null,c));return l},s.n=function(r){var o=r&&r.__esModule?function(){return r.default}:function(){return r};return s.d(o,"a",o),o},s.o=function(r,o){return Object.prototype.hasOwnProperty.call(r,o)},s.p="dist",s(s.s=10)}([function(t,i,s){function r(o,l){var c=Object.prototype.hasOwnProperty,a,u,d,_;for(d=1,_=arguments.length;d<_;d+=1){a=arguments[d];for(u in a)c.call(a,u)&&(o[u]=a[u])}return o}t.exports=r},function(t,i,s){function r(o){return o===void 0}t.exports=r},function(t,i,s){function r(o){return o instanceof Array}t.exports=r},function(t,i,s){var r=s(2),o=s(17),l=s(6);function c(a,u,d){r(a)?o(a,u,d):l(a,u,d)}t.exports=c},function(t,i,s){function r(o){return typeof o=="string"||o instanceof String}t.exports=r},function(t,i,s){function r(o){return o instanceof Function}t.exports=r},function(t,i,s){function r(o,l,c){var a;c=c||null;for(a in o)if(o.hasOwnProperty(a)&&l.call(c,o[a],a,o)===!1)break}t.exports=r},function(t,i,s){var r=s(18),o=s(0);function l(c,a){var u;return a||(a=c,c=null),u=a.init||function(){},c&&r(u,c),a.hasOwnProperty("static")&&(o(u,a.static),delete a.static),o(u.prototype,a),u}t.exports=l},function(t,i,s){var r=s(2);function o(l,c,a){var u,d;if(a=a||0,!r(c))return-1;if(Array.prototype.indexOf)return Array.prototype.indexOf.call(c,l,a);for(d=c.length,u=a;a>=0&&u<d;u+=1)if(c[u]===l)return u;return-1}t.exports=o},function(t,i,s){var r=s(29),o=s(30),l=s(5),c={capitalizeFirstLetter:function(a){return a.substring(0,1).toUpperCase()+a.substring(1,a.length)},isContained:function(a,u){return u?a===u?!0:u.contains(a):!1},createElementByTemplate:function(a,u){var d=document.createElement("div"),_=l(a)?a(u):r(a,u);return d.innerHTML=_,d.firstChild},bind:function(a,u){var d=Array.prototype.slice,_;return a.bind?a.bind.apply(a,d.call(arguments,1)):(_=d.call(arguments,2),function(){return a.apply(u,_.length?_.concat(d.call(arguments)):arguments)})},sendHostName:function(){o("pagination","UA-129987462-1")}};t.exports=c},function(t,i,s){s(11),t.exports=s(12)},function(t,i,s){},function(t,i,s){var r=s(13),o=s(7),l=s(0),c=s(1),a=s(20),u=s(9),d={totalItems:10,itemsPerPage:10,visiblePages:10,page:1,centerAlign:!1,firstItemClassName:"tui-first-child",lastItemClassName:"tui-last-child",usageStatistics:!0},_=o({init:function(f,h){this._options=l({},d,h),this._currentPage=0,this._view=new a(f,this._options,u.bind(this._onClickHandler,this)),this._paginate(),this._options.usageStatistics&&u.sendHostName()},_setCurrentPage:function(f){this._currentPage=f||this._options.page},_getLastPage:function(){var f=Math.ceil(this._options.totalItems/this._options.itemsPerPage);return f||1},_getPageIndex:function(f){var h,p;return this._options.centerAlign?(h=Math.floor(this._options.visiblePages/2),p=f-h,p=Math.max(p,1),p=Math.min(p,this._getLastPage()-this._options.visiblePages+1),p):Math.ceil(f/this._options.visiblePages)},_getRelativePage:function(f){var h=f==="prev",p=this.getCurrentPage();return h?p-1:p+1},_getMorePageIndex:function(f){var h=this._getPageIndex(this.getCurrentPage()),p=this._options.visiblePages,g=f==="prev",y;return this._options.centerAlign?y=g?h-1:h+p:y=g?(h-1)*p:h*p+1,y},_convertToValidPage:function(f){var h=this._getLastPage();return f=Math.max(f,1),f=Math.min(f,h),f},_paginate:function(f){var h=this._makeViewData(f||this._options.page);this._setCurrentPage(f),this._view.update(h)},_makeViewData:function(f){var h={},p=this._getLastPage(),g=this._getPageIndex(f),y=this._getPageIndex(p),T=this._getEdge(f);return h.leftPageNumber=T.left,h.rightPageNumber=T.right,h.prevMore=g>1,h.nextMore=g<y,h.page=f,h.currentPageIndex=f,h.lastPage=p,h.lastPageListIndex=p,h},_getEdge:function(f){var h,p,g,y=this._getLastPage(),T=this._options.visiblePages,W=this._getPageIndex(f);return this._options.centerAlign?(g=Math.floor(T/2),h=Math.max(f-g,1),p=h+T-1,p>y&&(h=Math.max(y-T+1,1),p=y)):(h=(W-1)*T+1,p=W*T,p=Math.min(p,y)),{left:h,right:p}},_onClickHandler:function(f,h){switch(f){case"first":h=1;break;case"prev":h=this._getRelativePage("prev");break;case"next":h=this._getRelativePage("next");break;case"prevMore":h=this._getMorePageIndex("prev");break;case"nextMore":h=this._getMorePageIndex("next");break;case"last":h=this._getLastPage();break;default:if(!h)return}this.movePageTo(h)},reset:function(f){c(f)&&(f=this._options.totalItems),this._options.totalItems=f,this._paginate(1)},movePageTo:function(f){f=this._convertToValidPage(f),this.invoke("beforeMove",{page:f})&&(this._paginate(f),this.fire("afterMove",{page:f}))},setTotalItems:function(f){this._options.totalItems=f},setItemsPerPage:function(f){this._options.itemsPerPage=f},getCurrentPage:function(){return this._currentPage||this._options.page}});r.mixin(_),t.exports=_},function(t,i,s){var r=s(0),o=s(14),l=s(4),c=s(16),a=s(2),u=s(5),d=s(3),_=/\s+/g;function f(){this.events=null,this.contexts=null}f.mixin=function(h){r(h.prototype,f.prototype)},f.prototype._getHandlerItem=function(h,p){var g={handler:h};return p&&(g.context=p),g},f.prototype._safeEvent=function(h){var p=this.events,g;return p||(p=this.events={}),h&&(g=p[h],g||(g=[],p[h]=g),p=g),p},f.prototype._safeContext=function(){var h=this.contexts;return h||(h=this.contexts=[]),h},f.prototype._indexOfContext=function(h){for(var p=this._safeContext(),g=0;p[g];){if(h===p[g][0])return g;g+=1}return-1},f.prototype._memorizeContext=function(h){var p,g;o(h)&&(p=this._safeContext(),g=this._indexOfContext(h),g>-1?p[g][1]+=1:p.push([h,1]))},f.prototype._forgetContext=function(h){var p,g;o(h)&&(p=this._safeContext(),g=this._indexOfContext(h),g>-1&&(p[g][1]-=1,p[g][1]<=0&&p.splice(g,1)))},f.prototype._bindEvent=function(h,p,g){var y=this._safeEvent(h);this._memorizeContext(g),y.push(this._getHandlerItem(p,g))},f.prototype.on=function(h,p,g){var y=this;l(h)?(h=h.split(_),d(h,function(T){y._bindEvent(T,p,g)})):c(h)&&(g=p,d(h,function(T,W){y.on(W,T,g)}))},f.prototype.once=function(h,p,g){var y=this;if(c(h)){g=p,d(h,function(W,v){y.once(v,W,g)});return}function T(){p.apply(g,arguments),y.off(h,T,g)}this.on(h,T,g)},f.prototype._spliceMatches=function(h,p){var g=0,y;if(a(h))for(y=h.length;g<y;g+=1)p(h[g])===!0&&(h.splice(g,1),y-=1,g-=1)},f.prototype._matchHandler=function(h){var p=this;return function(g){var y=h===g.handler;return y&&p._forgetContext(g.context),y}},f.prototype._matchContext=function(h){var p=this;return function(g){var y=h===g.context;return y&&p._forgetContext(g.context),y}},f.prototype._matchHandlerAndContext=function(h,p){var g=this;return function(y){var T=h===y.handler,W=p===y.context,v=T&&W;return v&&g._forgetContext(y.context),v}},f.prototype._offByEventName=function(h,p){var g=this,y=u(p),T=g._matchHandler(p);h=h.split(_),d(h,function(W){var v=g._safeEvent(W);y?g._spliceMatches(v,T):(d(v,function(C){g._forgetContext(C.context)}),g.events[W]=[])})},f.prototype._offByHandler=function(h){var p=this,g=this._matchHandler(h);d(this._safeEvent(),function(y){p._spliceMatches(y,g)})},f.prototype._offByObject=function(h,p){var g=this,y;this._indexOfContext(h)<0?d(h,function(T,W){g.off(W,T)}):l(p)?(y=this._matchContext(h),g._spliceMatches(this._safeEvent(p),y)):u(p)?(y=this._matchHandlerAndContext(p,h),d(this._safeEvent(),function(T){g._spliceMatches(T,y)})):(y=this._matchContext(h),d(this._safeEvent(),function(T){g._spliceMatches(T,y)}))},f.prototype.off=function(h,p){l(h)?this._offByEventName(h,p):arguments.length?u(h)?this._offByHandler(h):c(h)&&this._offByObject(h,p):(this.events={},this.contexts=[])},f.prototype.fire=function(h){this.invoke.apply(this,arguments)},f.prototype.invoke=function(h){var p,g,y,T;if(!this.hasListener(h))return!0;for(p=this._safeEvent(h),g=Array.prototype.slice.call(arguments,1),y=0;p[y];){if(T=p[y],T.handler.apply(T.context,g)===!1)return!1;y+=1}return!0},f.prototype.hasListener=function(h){return this.getListenerLength(h)>0},f.prototype.getListenerLength=function(h){var p=this._safeEvent(h);return p.length},t.exports=f},function(t,i,s){var r=s(1),o=s(15);function l(c){return!r(c)&&!o(c)}t.exports=l},function(t,i,s){function r(o){return o===null}t.exports=r},function(t,i,s){function r(o){return o===Object(o)}t.exports=r},function(t,i,s){function r(o,l,c){var a=0,u=o.length;for(c=c||null;a<u&&l.call(c,o[a],a,o)!==!1;a+=1);}t.exports=r},function(t,i,s){var r=s(19);function o(l,c){var a=r(c.prototype);a.constructor=l,l.prototype=a}t.exports=o},function(t,i,s){function r(o){function l(){}return l.prototype=o,new l}t.exports=r},function(t,i,s){var r=s(3),o=s(7),l=s(21),c=s(22),a=s(24),u=s(25),d=s(0),_=s(4),f=s(28),h=s(9),p={page:'<a href="#" class="tui-page-btn">{{page}}</a>',currentPage:'<strong class="tui-page-btn tui-is-selected">{{page}}</strong>',moveButton:'<a href="#" class="tui-page-btn tui-{{type}}"><span class="tui-ico-{{type}}">{{type}}</span></a>',disabledMoveButton:'<span class="tui-page-btn tui-is-disabled tui-{{type}}"><span class="tui-ico-{{type}}">{{type}}</span></span>',moreButton:'<a href="#" class="tui-page-btn tui-{{type}}-is-ellip"><span class="tui-ico-ellip">...</span></a>'},g=["first","prev","next","last"],y=["prev","next"],T="The container element is invalid.",W=o({init:function(v,C,S){this._containerElement=null,this._firstItemClassName=C.firstItemClassName,this._lastItemClassName=C.lastItemClassName,this._template=d({},p,C.template),this._buttons={},this._enabledPageElements=[],this._setRootElement(v),this._setMoveButtons(),this._setDisabledMoveButtons(),this._setMoreButtons(),this._attachClickEvent(S)},_setRootElement:function(v){if(_(v)?v=document.getElementById(v)||document.querySelector(v):v.jquery&&(v=v[0]),!f(v))throw new Error(T);this._containerElement=v},_setMoveButtons:function(){r(g,function(v){this._buttons[v]=h.createElementByTemplate(this._template.moveButton,{type:v})},this)},_setDisabledMoveButtons:function(){r(g,function(v){var C="disabled"+h.capitalizeFirstLetter(v);this._buttons[C]=h.createElementByTemplate(this._template.disabledMoveButton,{type:v})},this)},_setMoreButtons:function(){r(y,function(v){var C=v+"More";this._buttons[C]=h.createElementByTemplate(this._template.moreButton,{type:v})},this)},_getContainerElement:function(){return this._containerElement},_appendFirstButton:function(v){var C;v.page>1?C=this._buttons.first:C=this._buttons.disabledFirst,this._getContainerElement().appendChild(C)},_appendPrevButton:function(v){var C;v.currentPageIndex>1?C=this._buttons.prev:C=this._buttons.disabledPrev,this._getContainerElement().appendChild(C)},_appendNextButton:function(v){var C;v.currentPageIndex<v.lastPageListIndex?C=this._buttons.next:C=this._buttons.disabledNext,this._getContainerElement().appendChild(C)},_appendLastButton:function(v){var C;v.page<v.lastPage?C=this._buttons.last:C=this._buttons.disabledLast,this._getContainerElement().appendChild(C)},_appendPrevMoreButton:function(v){var C;v.prevMore&&(C=this._buttons.prevMore,u(C,this._firstItemClassName),this._getContainerElement().appendChild(C))},_appendNextMoreButton:function(v){var C;v.nextMore&&(C=this._buttons.nextMore,u(C,this._lastItemClassName),this._getContainerElement().appendChild(C))},_appendPages:function(v){var C=v.leftPageNumber,S=v.rightPageNumber,O,U;for(U=C;U<=S;U+=1)U===v.page?O=h.createElementByTemplate(this._template.currentPage,{page:U}):(O=h.createElementByTemplate(this._template.page,{page:U}),this._enabledPageElements.push(O)),U===C&&!v.prevMore&&u(O,this._firstItemClassName),U===S&&!v.nextMore&&u(O,this._lastItemClassName),this._getContainerElement().appendChild(O)},_attachClickEvent:function(v){var C=this._getContainerElement();c(C,"click",function(S){var O=l(S),U,ce;a(S),ce=this._getButtonType(O),ce||(U=this._getPageNumber(O)),v(ce,U)},this)},_getButtonType:function(v){var C,S=this._buttons;return r(S,function(O,U){return h.isContained(v,O)?(C=U,!1):!0},this),C},_getPageNumber:function(v){var C=this._findPageElement(v),S;return C&&(S=parseInt(C.innerText,10)),S},_findPageElement:function(v){for(var C=0,S=this._enabledPageElements.length,O;C<S;C+=1)if(O=this._enabledPageElements[C],h.isContained(v,O))return O;return null},_empty:function(){this._enabledPageElements=[],r(this._buttons,function(v,C){this._buttons[C]=v.cloneNode(!0)},this),this._getContainerElement().innerHTML=""},update:function(v){this._empty(),this._appendFirstButton(v),this._appendPrevButton(v),this._appendPrevMoreButton(v),this._appendPages(v),this._appendNextMoreButton(v),this._appendNextButton(v),this._appendLastButton(v)}});t.exports=W},function(t,i,s){function r(o){return o.target||o.srcElement}t.exports=r},function(t,i,s){var r=s(4),o=s(3),l=s(23);function c(d,_,f,h){if(r(_)){o(_.split(/\s+/g),function(p){a(d,p,f,h)});return}o(_,function(p,g){a(d,g,p,f)})}function a(d,_,f,h){function p(g){f.call(h||d,g||window.event)}"addEventListener"in d?d.addEventListener(_,p):"attachEvent"in d&&d.attachEvent("on"+_,p),u(d,_,f,p)}function u(d,_,f,h){var p=l(d,_),g=!1;o(p,function(y){return y.handler===f?(g=!0,!1):!0}),g||p.push({handler:f,wrappedHandler:h})}t.exports=c},function(t,i,s){var r="_feEventKey";function o(l,c){var a=l[r],u;return a||(a=l[r]={}),u=a[c],u||(u=a[c]=[]),u}t.exports=o},function(t,i,s){function r(o){if(o.preventDefault){o.preventDefault();return}o.returnValue=!1}t.exports=r},function(t,i,s){var r=s(3),o=s(8),l=s(26),c=s(27);function a(u){var d=Array.prototype.slice.call(arguments,1),_=u.classList,f=[],h;if(_){r(d,function(p){u.classList.add(p)});return}h=l(u),h&&(d=[].concat(h.split(/\s+/),d)),r(d,function(p){o(p,f)<0&&f.push(p)}),c(u,f)}t.exports=a},function(t,i,s){var r=s(1);function o(l){return!l||!l.className?"":r(l.className.baseVal)?l.className:l.className.baseVal}t.exports=o},function(t,i,s){var r=s(2),o=s(1);function l(c,a){if(a=r(a)?a.join(" "):a,a=a.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),o(c.className.baseVal)){c.className=a;return}c.className.baseVal=a}t.exports=l},function(t,i,s){function r(o){return typeof HTMLElement=="object"?o&&(o instanceof HTMLElement||!!o.nodeType):!!(o&&o.nodeType)}t.exports=r},function(t,i,s){var r=s(8),o=s(3),l=s(2),c=s(4),a=s(0),u=/{{\s?|\s?}}/g,d=/^[a-zA-Z0-9_@]+\[[a-zA-Z0-9_@"']+\]$/,_=/\[\s?|\s?\]/,f=/^[a-zA-Z_]+\.[a-zA-Z_]+$/,h=/\./,p=/^["']\w+["']$/,g=/"|'/g,y=/^-?\d+\.?\d*$/,T=2,W={if:U,each:ce,with:Ys},v="a".split(/a/).length===3,C=function(){return v?function(E,w){return E.split(w)}:function(E,w){var b=[],P=0,A,D;for(w.global||(w=new RegExp(w,"g")),A=w.exec(E);A!==null;)D=A.index,b.push(E.slice(P,D)),P=D+A[0].length,A=w.exec(E);return b.push(E.slice(P)),b}}();function S(E,w){var b,P=w[E];return E==="true"?P=!0:E==="false"?P=!1:p.test(E)?P=E.replace(g,""):d.test(E)?(b=E.split(_),P=S(b[0],w)[S(b[1],w)]):f.test(E)?(b=E.split(h),P=S(b[0],w)[b[1]]):y.test(E)&&(P=parseFloat(E)),P}function O(E,w){var b=[E],P=[],A=0,D=0;return o(w,function(H,J){H.indexOf("if")===0?A+=1:H==="/if"?A-=1:!A&&(H.indexOf("elseif")===0||H==="else")&&(b.push(H==="else"?["true"]:H.split(" ").slice(1)),P.push(w.slice(D,J)),D=J+1)}),P.push(w.slice(D)),{exps:b,sourcesInsideIf:P}}function U(E,w,b){var P=O(E,w),A=!1,D="";return o(P.exps,function(H,J){return A=ct(H,b),A&&(D=ut(P.sourcesInsideIf[J],b)),!A}),D}function ce(E,w,b){var P=ct(E,b),A=l(P)?"@index":"@key",D={},H="";return o(P,function(J,Te){D[A]=Te,D["@this"]=J,a(b,D),H+=ut(w.slice(),b)}),H}function Ys(E,w,b){var P=r("as",E),A=E[P+1],D=ct(E.slice(0,P),b),H={};return H[A]=D,ut(w,a(b,H))||""}function js(E,w,b){var P=E.splice(w+1,b-w);return P.pop(),P}function Ks(E,w,b){for(var P=W[E],A=1,D=0,H,J=D+T,Te=w[J];A&&c(Te);)Te.indexOf(E)===0?A+=1:Te.indexOf("/"+E)===0&&(A-=1,H=J),J+=T,Te=w[J];if(A)throw Error(E+" needs {{/"+E+"}} expression.");return w[D]=P(w[D].split(" ").slice(1),js(w,D,H),b),w}function ct(E,w){var b=S(E[0],w);return b instanceof Function?$s(b,E.slice(1),w):b}function $s(E,w,b){var P=[];return o(w,function(A){P.push(S(A,b))}),E.apply(null,P)}function ut(E,w){for(var b=1,P=E[b],A,D,H;c(P);)A=P.split(" "),D=A[0],W[D]?(H=Ks(D,E.splice(b,E.length-b),w),E=E.concat(H)):E[b]=ct(A,w),b+=T,P=E[b];return E.join("")}function Qs(E,w){return ut(C(E,u),w)}t.exports=Qs},function(t,i,s){var r=s(1),o=s(31),l=7*24*60*60*1e3;function c(u){var d=new Date().getTime();return d-u>l}function a(u,d){var _="https://www.google-analytics.com/collect",f=location.hostname,h="event",p="use",g="TOAST UI "+u+" for "+f+": Statistics",y=window.localStorage.getItem(g);!r(window.tui)&&window.tui.usageStatistics===!1||y&&!c(y)||(window.localStorage.setItem(g,new Date().getTime()),setTimeout(function(){(document.readyState==="interactive"||document.readyState==="complete")&&o(_,{v:1,t:h,tid:d,cid:f,dp:f,dh:u,el:u,ec:p})},1e3))}t.exports=a},function(t,i,s){var r=s(6);function o(l,c){var a=document.createElement("img"),u="";return r(c,function(d,_){u+="&"+_+"="+d}),u=u.substring(1),a.src=l+"?"+u,a.style.display="none",document.body.appendChild(a),document.body.removeChild(a),a}t.exports=o}])})})(mr);const vr=gr(jt);function yr(n,e){return{totalItems:n.length,itemsPerPage:1,visiblePages:e,page:1,centerAlign:!0,firstItemClassName:"tui-first-child",lastItemClassName:"tui-last-child",template:{page:'<a href="#" class="tui-page-btn">{{page}}</a>',currentPage:'<strong class="tui-page-btn tui-is-selected">{{page}}</strong>',moveButton:'<a href="#" class="tui-page-btn tui-{{type}}"><span class="tui-ico-{{type}}">{{ type }}</span></a>',disabledMoveButton:'<span class="tui-page-btn tui-is-disabled tui-{{type}}"><span class="tui-ico-{{type}}">{{ type }}</span></span>',moreButton:'<a href="#" class="tui-page-btn tui-{{type}}-is-ellip"><span class="tui-ico-ellip">...</span></a>'}}}function Cr(n,e,t){const i=document.getElementById("pagination");new vr(i,n).on("afterMove",function(r){const o=r.page-1,l=e[o];booksContainer.innerHTML="",t(l)})}var Er="Expected a function",Gn=0/0,Ir="[object Symbol]",Tr=/^\s+|\s+$/g,wr=/^[-+]0x[0-9a-f]+$/i,Sr=/^0b[01]+$/i,br=/^0o[0-7]+$/i,xr=parseInt,Nr=typeof ht=="object"&&ht&&ht.Object===Object&&ht,Pr=typeof self=="object"&&self&&self.Object===Object&&self,Rr=Nr||Pr||Function("return this")(),kr=Object.prototype,Ar=kr.toString,Mr=Math.max,Or=Math.min,Wt=function(){return Rr.Date.now()};function Lr(n,e,t){var i,s,r,o,l,c,a=0,u=!1,d=!1,_=!0;if(typeof n!="function")throw new TypeError(Er);e=qn(e)||0,Kt(t)&&(u=!!t.leading,d="maxWait"in t,r=d?Mr(qn(t.maxWait)||0,e):r,_="trailing"in t?!!t.trailing:_);function f(S){var O=i,U=s;return i=s=void 0,a=S,o=n.apply(U,O),o}function h(S){return a=S,l=setTimeout(y,e),u?f(S):o}function p(S){var O=S-c,U=S-a,ce=e-O;return d?Or(ce,r-U):ce}function g(S){var O=S-c,U=S-a;return c===void 0||O>=e||O<0||d&&U>=r}function y(){var S=Wt();if(g(S))return T(S);l=setTimeout(y,p(S))}function T(S){return l=void 0,_&&i?f(S):(i=s=void 0,o)}function W(){l!==void 0&&clearTimeout(l),a=0,i=c=s=l=void 0}function v(){return l===void 0?o:T(Wt())}function C(){var S=Wt(),O=g(S);if(i=arguments,s=this,c=S,O){if(l===void 0)return h(c);if(d)return l=setTimeout(y,e),f(c)}return l===void 0&&(l=setTimeout(y,e)),o}return C.cancel=W,C.flush=v,C}function Kt(n){var e=typeof n;return!!n&&(e=="object"||e=="function")}function Dr(n){return!!n&&typeof n=="object"}function Fr(n){return typeof n=="symbol"||Dr(n)&&Ar.call(n)==Ir}function qn(n){if(typeof n=="number")return n;if(Fr(n))return Gn;if(Kt(n)){var e=typeof n.valueOf=="function"?n.valueOf():n;n=Kt(e)?e+"":e}if(typeof n!="string")return n===0?n:+n;n=n.replace(Tr,"");var t=Sr.test(n);return t||br.test(n)?xr(n.slice(2),t?2:8):wr.test(n)?Gn:+n}var Wr=Lr;const zn="@firebase/database",Yn="0.14.4";let bi="";function Br(n){bi=n}class Ur{constructor(e){this.domStorage_=e,this.prefix_="firebase:"}set(e,t){t==null?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),V(t))}get(e){const t=this.domStorage_.getItem(this.prefixedName_(e));return t==null?null:an(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}}class Hr{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){t==null?delete this.cache_[e]:this.cache_[e]=t}get(e){return le(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}}const xi=function(n){try{if(typeof window<"u"&&typeof window[n]<"u"){const e=window[n];return e.setItem("firebase:sentinel","cache"),e.removeItem("firebase:sentinel"),new Ur(e)}}catch{}return new Hr},ge=xi("localStorage"),$t=xi("sessionStorage");const be=new or("@firebase/database"),Vr=function(){let n=1;return function(){return n++}}(),Ni=function(n){const e=ir(n),t=new sr;t.update(e);const i=t.digest();return rr.encodeByteArray(i)},it=function(...n){let e="";for(let t=0;t<n.length;t++){const i=n[t];Array.isArray(i)||i&&typeof i=="object"&&typeof i.length=="number"?e+=it.apply(null,i):typeof i=="object"?e+=V(i):e+=i,e+=" "}return e};let ve=null,jn=!0;const Gr=function(n,e){m(!e||n===!0||n===!1,"Can't turn on custom loggers persistently."),n===!0?(be.logLevel=lr.VERBOSE,ve=be.log.bind(be),e&&$t.set("logging_enabled",!0)):typeof n=="function"?ve=n:(ve=null,$t.remove("logging_enabled"))},j=function(...n){if(jn===!0&&(jn=!1,ve===null&&$t.get("logging_enabled")===!0&&Gr(!0)),ve){const e=it.apply(null,n);ve(e)}},st=function(n){return function(...e){j(n,...e)}},Qt=function(...n){const e="FIREBASE INTERNAL ERROR: "+it(...n);be.error(e)},oe=function(...n){const e=`FIREBASE FATAL ERROR: ${it(...n)}`;throw be.error(e),new Error(e)},Q=function(...n){const e="FIREBASE WARNING: "+it(...n);be.warn(e)},qr=function(){typeof window<"u"&&window.location&&window.location.protocol&&window.location.protocol.indexOf("https:")!==-1&&Q("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},Pi=function(n){return typeof n=="number"&&(n!==n||n===Number.POSITIVE_INFINITY||n===Number.NEGATIVE_INFINITY)},zr=function(n){if(document.readyState==="complete")n();else{let e=!1;const t=function(){if(!document.body){setTimeout(t,Math.floor(10));return}e||(e=!0,n())};document.addEventListener?(document.addEventListener("DOMContentLoaded",t,!1),window.addEventListener("load",t,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{document.readyState==="complete"&&t()}),window.attachEvent("onload",t))}},Re="[MIN_NAME]",ye="[MAX_NAME]",Oe=function(n,e){if(n===e)return 0;if(n===Re||e===ye)return-1;if(e===Re||n===ye)return 1;{const t=Kn(n),i=Kn(e);return t!==null?i!==null?t-i===0?n.length-e.length:t-i:-1:i!==null?1:n<e?-1:1}},Yr=function(n,e){return n===e?0:n<e?-1:1},Fe=function(n,e){if(e&&n in e)return e[n];throw new Error("Missing required key ("+n+") in object: "+V(e))},hn=function(n){if(typeof n!="object"||n===null)return V(n);const e=[];for(const i in n)e.push(i);e.sort();let t="{";for(let i=0;i<e.length;i++)i!==0&&(t+=","),t+=V(e[i]),t+=":",t+=hn(n[e[i]]);return t+="}",t},Ri=function(n,e){const t=n.length;if(t<=e)return[n];const i=[];for(let s=0;s<t;s+=e)s+e>t?i.push(n.substring(s,t)):i.push(n.substring(s,s+e));return i};function X(n,e){for(const t in n)n.hasOwnProperty(t)&&e(t,n[t])}const ki=function(n){m(!Pi(n),"Invalid JSON number");const e=11,t=52,i=(1<<e-1)-1;let s,r,o,l,c;n===0?(r=0,o=0,s=1/n===-1/0?1:0):(s=n<0,n=Math.abs(n),n>=Math.pow(2,1-i)?(l=Math.min(Math.floor(Math.log(n)/Math.LN2),i),r=l+i,o=Math.round(n*Math.pow(2,t-l)-Math.pow(2,t))):(r=0,o=Math.round(n/Math.pow(2,1-i-t))));const a=[];for(c=t;c;c-=1)a.push(o%2?1:0),o=Math.floor(o/2);for(c=e;c;c-=1)a.push(r%2?1:0),r=Math.floor(r/2);a.push(s?1:0),a.reverse();const u=a.join("");let d="";for(c=0;c<64;c+=8){let _=parseInt(u.substr(c,8),2).toString(16);_.length===1&&(_="0"+_),d=d+_}return d.toLowerCase()},jr=function(){return!!(typeof window=="object"&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))},Kr=function(){return typeof Windows=="object"&&typeof Windows.UI=="object"};function $r(n,e){let t="Unknown Error";n==="too_big"?t="The data requested exceeds the maximum size that can be accessed with a single request.":n==="permission_denied"?t="Client doesn't have permission to access the desired data.":n==="unavailable"&&(t="The service is unavailable");const i=new Error(n+" at "+e._path.toString()+": "+t);return i.code=n.toUpperCase(),i}const Qr=new RegExp("^-?(0*)\\d{1,10}$"),Xr=-2147483648,Jr=2147483647,Kn=function(n){if(Qr.test(n)){const e=Number(n);if(e>=Xr&&e<=Jr)return e}return null},Le=function(n){try{n()}catch(e){setTimeout(()=>{const t=e.stack||"";throw Q("Exception was thrown by user callback.",t),e},Math.floor(0))}},Zr=function(){return(typeof window=="object"&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},He=function(n,e){const t=setTimeout(n,e);return typeof t=="number"&&typeof Deno<"u"&&Deno.unrefTimer?Deno.unrefTimer(t):typeof t=="object"&&t.unref&&t.unref(),t};class eo{constructor(e,t){this.appName_=e,this.appCheckProvider=t,this.appCheck=t==null?void 0:t.getImmediate({optional:!0}),this.appCheck||t==null||t.get().then(i=>this.appCheck=i)}getToken(e){return this.appCheck?this.appCheck.getToken(e):new Promise((t,i)=>{setTimeout(()=>{this.appCheck?this.getToken(e).then(t,i):t(null)},0)})}addTokenChangeListener(e){var t;(t=this.appCheckProvider)===null||t===void 0||t.get().then(i=>i.addTokenListener(e))}notifyForInvalidToken(){Q(`Provided AppCheck credentials for the app named "${this.appName_}" are invalid. This usually indicates your app was not initialized correctly.`)}}class to{constructor(e,t,i){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=i,this.auth_=null,this.auth_=i.getImmediate({optional:!0}),this.auth_||i.onInit(s=>this.auth_=s)}getToken(e){return this.auth_?this.auth_.getToken(e).catch(t=>t&&t.code==="auth/token-not-initialized"?(j("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(t)):new Promise((t,i)=>{setTimeout(()=>{this.auth_?this.getToken(e).then(t,i):t(null)},0)})}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then(t=>t.addAuthTokenListener(e))}removeTokenChangeListener(e){this.authProvider_.get().then(t=>t.removeAuthTokenListener(e))}notifyForInvalidToken(){let e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?e+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?e+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':e+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',Q(e)}}class xe{constructor(e){this.accessToken=e}getToken(e){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(e){e(this.accessToken)}removeTokenChangeListener(e){}notifyForInvalidToken(){}}xe.OWNER="owner";const dn="5",Ai="v",Mi="s",Oi="r",Li="f",Di=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,Fi="ls",Wi="p",Xt="ac",Bi="websocket",Ui="long_polling";class Hi{constructor(e,t,i,s,r=!1,o="",l=!1,c=!1){this.secure=t,this.namespace=i,this.webSocketOnly=s,this.nodeAdmin=r,this.persistenceKey=o,this.includeNamespaceInQueryParams=l,this.isUsingEmulator=c,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=ge.get("host:"+e)||this._host}isCacheableHost(){return this.internalHost.substr(0,2)==="s-"}isCustomHost(){return this._domain!=="firebaseio.com"&&this._domain!=="firebaseio-demo.com"}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&ge.set("host:"+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e}toURLString(){const e=this.secure?"https://":"http://",t=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${e}${this.host}/${t}`}}function no(n){return n.host!==n.internalHost||n.isCustomHost()||n.includeNamespaceInQueryParams}function Vi(n,e,t){m(typeof e=="string","typeof type must == string"),m(typeof t=="object","typeof params must == object");let i;if(e===Bi)i=(n.secure?"wss://":"ws://")+n.internalHost+"/.ws?";else if(e===Ui)i=(n.secure?"https://":"http://")+n.internalHost+"/.lp?";else throw new Error("Unknown connection type: "+e);no(n)&&(t.ns=n.namespace);const s=[];return X(t,(r,o)=>{s.push(r+"="+o)}),i+s.join("&")}class io{constructor(){this.counters_={}}incrementCounter(e,t=1){le(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return dr(this.counters_)}}const Bt={},Ut={};function fn(n){const e=n.toString();return Bt[e]||(Bt[e]=new io),Bt[e]}function so(n,e){const t=n.toString();return Ut[t]||(Ut[t]=e()),Ut[t]}class ro{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){for(this.pendingResponses[e]=t;this.pendingResponses[this.currentResponseNum];){const i=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let s=0;s<i.length;++s)i[s]&&Le(()=>{this.onMessage_(i[s])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}}const $n="start",oo="close",lo="pLPCommand",ao="pRTLPCB",Gi="id",qi="pw",zi="ser",co="cb",uo="seg",ho="ts",fo="d",_o="dframe",Yi=1870,ji=30,po=Yi-ji,go=25e3,mo=3e4;class Se{constructor(e,t,i,s,r,o,l){this.connId=e,this.repoInfo=t,this.applicationId=i,this.appCheckToken=s,this.authToken=r,this.transportSessionId=o,this.lastSessionId=l,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=st(e),this.stats_=fn(t),this.urlFn=c=>(this.appCheckToken&&(c[Xt]=this.appCheckToken),Vi(t,Ui,c))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new ro(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(mo)),zr(()=>{if(this.isClosed_)return;this.scriptTagHolder=new _n((...r)=>{const[o,l,c,a,u]=r;if(this.incrementIncomingBytes_(r),!!this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,o===$n)this.id=l,this.password=c;else if(o===oo)l?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(l,()=>{this.onClosed_()})):this.onClosed_();else throw new Error("Unrecognized command received: "+o)},(...r)=>{const[o,l]=r;this.incrementIncomingBytes_(r),this.myPacketOrderer.handleResponse(o,l)},()=>{this.onClosed_()},this.urlFn);const i={};i[$n]="t",i[zi]=Math.floor(Math.random()*1e8),this.scriptTagHolder.uniqueCallbackIdentifier&&(i[co]=this.scriptTagHolder.uniqueCallbackIdentifier),i[Ai]=dn,this.transportSessionId&&(i[Mi]=this.transportSessionId),this.lastSessionId&&(i[Fi]=this.lastSessionId),this.applicationId&&(i[Wi]=this.applicationId),this.appCheckToken&&(i[Xt]=this.appCheckToken),typeof location<"u"&&location.hostname&&Di.test(location.hostname)&&(i[Oi]=Li);const s=this.urlFn(i);this.log_("Connecting via long-poll to "+s),this.scriptTagHolder.addTag(s,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){Se.forceAllow_=!0}static forceDisallow(){Se.forceDisallow_=!0}static isAvailable(){return Se.forceAllow_?!0:!Se.forceDisallow_&&typeof document<"u"&&document.createElement!=null&&!jr()&&!Kr()}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(e){const t=V(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);const i=_r(t),s=Ri(i,po);for(let r=0;r<s.length;r++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,s.length,s[r]),this.curSegmentNum++}addDisconnectPingFrame(e,t){this.myDisconnFrame=document.createElement("iframe");const i={};i[_o]="t",i[Gi]=e,i[qi]=t,this.myDisconnFrame.src=this.urlFn(i),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){const t=V(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)}}class _n{constructor(e,t,i,s){this.onDisconnect=i,this.urlFn=s,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(Math.random()*1e8),this.sendNewPolls=!0;{this.uniqueCallbackIdentifier=Vr(),window[lo+this.uniqueCallbackIdentifier]=e,window[ao+this.uniqueCallbackIdentifier]=t,this.myIFrame=_n.createIFrame_();let r="";this.myIFrame.src&&this.myIFrame.src.substr(0,11)==="javascript:"&&(r='<script>document.domain="'+document.domain+'";<\/script>');const o="<html><body>"+r+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(o),this.myIFrame.doc.close()}catch(l){j("frame writing exception"),l.stack&&j(l.stack),j(l)}}}static createIFrame_(){const e=document.createElement("iframe");if(e.style.display="none",document.body){document.body.appendChild(e);try{e.contentWindow.document||j("No IE domain setting required")}catch{const i=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+i+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout(()=>{this.myIFrame!==null&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));const e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;const e={};e[Gi]=this.myID,e[qi]=this.myPW,e[zi]=this.currentSerial;let t=this.urlFn(e),i="",s=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+ji+i.length<=Yi;){const o=this.pendingSegs.shift();i=i+"&"+uo+s+"="+o.seg+"&"+ho+s+"="+o.ts+"&"+fo+s+"="+o.d,s++}return t=t+i,this.addLongPollTag_(t,this.currentSerial),!0}else return!1}enqueueSegment(e,t,i){this.pendingSegs.push({seg:e,ts:t,d:i}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);const i=()=>{this.outstandingRequests.delete(t),this.newRequest_()},s=setTimeout(i,Math.floor(go)),r=()=>{clearTimeout(s),i()};this.addTag(e,r)}addTag(e,t){setTimeout(()=>{try{if(!this.sendNewPolls)return;const i=this.myIFrame.doc.createElement("script");i.type="text/javascript",i.async=!0,i.src=e,i.onload=i.onreadystatechange=function(){const s=i.readyState;(!s||s==="loaded"||s==="complete")&&(i.onload=i.onreadystatechange=null,i.parentNode&&i.parentNode.removeChild(i),t())},i.onerror=()=>{j("Long-poll script failed to load: "+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(i)}catch{}},Math.floor(1))}}const vo=16384,yo=45e3;let pt=null;typeof MozWebSocket<"u"?pt=MozWebSocket:typeof WebSocket<"u"&&(pt=WebSocket);class Z{constructor(e,t,i,s,r,o,l){this.connId=e,this.applicationId=i,this.appCheckToken=s,this.authToken=r,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=st(this.connId),this.stats_=fn(t),this.connURL=Z.connectionURL_(t,o,l,s,i),this.nodeAdmin=t.nodeAdmin}static connectionURL_(e,t,i,s,r){const o={};return o[Ai]=dn,typeof location<"u"&&location.hostname&&Di.test(location.hostname)&&(o[Oi]=Li),t&&(o[Mi]=t),i&&(o[Fi]=i),s&&(o[Xt]=s),r&&(o[Wi]=r),Vi(e,Bi,o)}open(e,t){this.onDisconnect=t,this.onMessage=e,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,ge.set("previous_websocket_failure",!0);try{let i;wi(),this.mySock=new pt(this.connURL,[],i)}catch(i){this.log_("Error instantiating WebSocket.");const s=i.message||i.data;s&&this.log_(s),this.onClosed_();return}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=i=>{this.handleIncomingFrame(i)},this.mySock.onerror=i=>{this.log_("WebSocket error.  Closing connection.");const s=i.message||i.data;s&&this.log_(s),this.onClosed_()}}start(){}static forceDisallow(){Z.forceDisallow_=!0}static isAvailable(){let e=!1;if(typeof navigator<"u"&&navigator.userAgent){const t=/Android ([0-9]{0,}\.[0-9]{0,})/,i=navigator.userAgent.match(t);i&&i.length>1&&parseFloat(i[1])<4.4&&(e=!0)}return!e&&pt!==null&&!Z.forceDisallow_}static previouslyFailed(){return ge.isInMemoryStorage||ge.get("previous_websocket_failure")===!0}markConnectionHealthy(){ge.remove("previous_websocket_failure")}appendFrame_(e){if(this.frames.push(e),this.frames.length===this.totalFrames){const t=this.frames.join("");this.frames=null;const i=an(t);this.onMessage(i)}}handleNewFrameCount_(e){this.totalFrames=e,this.frames=[]}extractFrameCount_(e){if(m(this.frames===null,"We already have a frame buffer"),e.length<=6){const t=Number(e);if(!isNaN(t))return this.handleNewFrameCount_(t),null}return this.handleNewFrameCount_(1),e}handleIncomingFrame(e){if(this.mySock===null)return;const t=e.data;if(this.bytesReceived+=t.length,this.stats_.incrementCounter("bytes_received",t.length),this.resetKeepAlive(),this.frames!==null)this.appendFrame_(t);else{const i=this.extractFrameCount_(t);i!==null&&this.appendFrame_(i)}}send(e){this.resetKeepAlive();const t=V(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);const i=Ri(t,vo);i.length>1&&this.sendString_(String(i.length));for(let s=0;s<i.length;s++)this.sendString_(i[s])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(yo))}sendString_(e){try{this.mySock.send(e)}catch(t){this.log_("Exception thrown from WebSocket.send():",t.message||t.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}Z.responsesRequiredToBeHealthy=2;Z.healthyTimeout=3e4;class Ye{constructor(e){this.initTransports_(e)}static get ALL_TRANSPORTS(){return[Se,Z]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}initTransports_(e){const t=Z&&Z.isAvailable();let i=t&&!Z.previouslyFailed();if(e.webSocketOnly&&(t||Q("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),i=!0),i)this.transports_=[Z];else{const s=this.transports_=[];for(const r of Ye.ALL_TRANSPORTS)r&&r.isAvailable()&&s.push(r);Ye.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}Ye.globalTransportInitialized_=!1;const Co=6e4,Eo=5e3,Io=10*1024,To=100*1024,Ht="t",Qn="d",wo="s",Xn="r",So="e",Jn="o",Zn="a",ei="n",ti="p",bo="h";class xo{constructor(e,t,i,s,r,o,l,c,a,u){this.id=e,this.repoInfo_=t,this.applicationId_=i,this.appCheckToken_=s,this.authToken_=r,this.onMessage_=o,this.onReady_=l,this.onDisconnect_=c,this.onKill_=a,this.lastSessionId=u,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=st("c:"+this.id+":"),this.transportManager_=new Ye(t),this.log_("Connection created"),this.start_()}start_(){const e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;const t=this.connReceiver_(this.conn_),i=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(t,i)},Math.floor(0));const s=e.healthyTimeout||0;s>0&&(this.healthyTimeout_=He(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>To?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>Io?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(s)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(e){return t=>{this.state_!==2&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_("message on old connection"))}}sendRequest(e){const t={t:"d",d:e};this.sendData_(t)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if(Ht in e){const t=e[Ht];t===Zn?this.upgradeIfSecondaryHealthy_():t===Xn?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):t===Jn&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){const t=Fe("t",e),i=Fe("d",e);if(t==="c")this.onSecondaryControl_(i);else if(t==="d")this.pendingDataMessages.push(i);else throw new Error("Unknown protocol layer: "+t)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:ti,d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:Zn,d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:ei,d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){const t=Fe("t",e),i=Fe("d",e);t==="c"?this.onControl_(i):t==="d"&&this.onDataMessage_(i)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){const t=Fe(Ht,e);if(Qn in e){const i=e[Qn];if(t===bo){const s=Object.assign({},i);this.repoInfo_.isUsingEmulator&&(s.h=this.repoInfo_.host),this.onHandshake_(s)}else if(t===ei){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let s=0;s<this.pendingDataMessages.length;++s)this.onDataMessage_(this.pendingDataMessages[s]);this.pendingDataMessages=[],this.tryCleanupConnection()}else t===wo?this.onConnectionShutdown_(i):t===Xn?this.onReset_(i):t===So?Qt("Server Error: "+i):t===Jn?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):Qt("Unknown control packet command: "+t)}}onHandshake_(e){const t=e.ts,i=e.v,s=e.h;this.sessionId=e.s,this.repoInfo_.host=s,this.state_===0&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),dn!==i&&Q("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){const e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;const t=this.connReceiver_(this.secondaryConn_),i=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,i),He(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(Co))}onReset_(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,this.state_===1?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),this.primaryResponsesRequired_===0?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):He(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(Eo))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&this.state_===1&&(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:ti,d:{}}}))}onSecondaryConnectionLost_(){const e=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===e||this.rx_===e)&&this.close()}onConnectionLost_(e){this.conn_=null,!e&&this.state_===0?(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(ge.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)):this.state_===1&&this.log_("Realtime connection lost."),this.close()}onConnectionShutdown_(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(e){if(this.state_!==1)throw"Connection is not connected";this.tx_.send(e)}close(){this.state_!==2&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}}class Ki{put(e,t,i,s){}merge(e,t,i,s){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,i){}onDisconnectMerge(e,t,i){}onDisconnectCancel(e,t){}reportStats(e){}}class $i{constructor(e){this.allowedEvents_=e,this.listeners_={},m(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}trigger(e,...t){if(Array.isArray(this.listeners_[e])){const i=[...this.listeners_[e]];for(let s=0;s<i.length;s++)i[s].callback.apply(i[s].context,t)}}on(e,t,i){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:i});const s=this.getInitialEvent(e);s&&t.apply(i,s)}off(e,t,i){this.validateEventType_(e);const s=this.listeners_[e]||[];for(let r=0;r<s.length;r++)if(s[r].callback===t&&(!i||i===s[r].context)){s.splice(r,1);return}}validateEventType_(e){m(this.allowedEvents_.find(t=>t===e),"Unknown event: "+e)}}class gt extends $i{constructor(){super(["online"]),this.online_=!0,typeof window<"u"&&typeof window.addEventListener<"u"&&!Si()&&(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}static getInstance(){return new gt}getInitialEvent(e){return m(e==="online","Unknown event type: "+e),[this.online_]}currentlyOnline(){return this.online_}}const ni=32,ii=768;class M{constructor(e,t){if(t===void 0){this.pieces_=e.split("/");let i=0;for(let s=0;s<this.pieces_.length;s++)this.pieces_[s].length>0&&(this.pieces_[i]=this.pieces_[s],i++);this.pieces_.length=i,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e="";for(let t=this.pieceNum_;t<this.pieces_.length;t++)this.pieces_[t]!==""&&(e+="/"+this.pieces_[t]);return e||"/"}}function k(){return new M("")}function R(n){return n.pieceNum_>=n.pieces_.length?null:n.pieces_[n.pieceNum_]}function de(n){return n.pieces_.length-n.pieceNum_}function L(n){let e=n.pieceNum_;return e<n.pieces_.length&&e++,new M(n.pieces_,e)}function Qi(n){return n.pieceNum_<n.pieces_.length?n.pieces_[n.pieces_.length-1]:null}function No(n){let e="";for(let t=n.pieceNum_;t<n.pieces_.length;t++)n.pieces_[t]!==""&&(e+="/"+encodeURIComponent(String(n.pieces_[t])));return e||"/"}function Xi(n,e=0){return n.pieces_.slice(n.pieceNum_+e)}function Ji(n){if(n.pieceNum_>=n.pieces_.length)return null;const e=[];for(let t=n.pieceNum_;t<n.pieces_.length-1;t++)e.push(n.pieces_[t]);return new M(e,0)}function G(n,e){const t=[];for(let i=n.pieceNum_;i<n.pieces_.length;i++)t.push(n.pieces_[i]);if(e instanceof M)for(let i=e.pieceNum_;i<e.pieces_.length;i++)t.push(e.pieces_[i]);else{const i=e.split("/");for(let s=0;s<i.length;s++)i[s].length>0&&t.push(i[s])}return new M(t,0)}function N(n){return n.pieceNum_>=n.pieces_.length}function K(n,e){const t=R(n),i=R(e);if(t===null)return e;if(t===i)return K(L(n),L(e));throw new Error("INTERNAL ERROR: innerPath ("+e+") is not within outerPath ("+n+")")}function Zi(n,e){if(de(n)!==de(e))return!1;for(let t=n.pieceNum_,i=e.pieceNum_;t<=n.pieces_.length;t++,i++)if(n.pieces_[t]!==e.pieces_[i])return!1;return!0}function ee(n,e){let t=n.pieceNum_,i=e.pieceNum_;if(de(n)>de(e))return!1;for(;t<n.pieces_.length;){if(n.pieces_[t]!==e.pieces_[i])return!1;++t,++i}return!0}class Po{constructor(e,t){this.errorPrefix_=t,this.parts_=Xi(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let i=0;i<this.parts_.length;i++)this.byteLength_+=Nt(this.parts_[i]);es(this)}}function Ro(n,e){n.parts_.length>0&&(n.byteLength_+=1),n.parts_.push(e),n.byteLength_+=Nt(e),es(n)}function ko(n){const e=n.parts_.pop();n.byteLength_-=Nt(e),n.parts_.length>0&&(n.byteLength_-=1)}function es(n){if(n.byteLength_>ii)throw new Error(n.errorPrefix_+"has a key path longer than "+ii+" bytes ("+n.byteLength_+").");if(n.parts_.length>ni)throw new Error(n.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+ni+") or object contains a cycle "+pe(n))}function pe(n){return n.parts_.length===0?"":"in property '"+n.parts_.join(".")+"'"}class pn extends $i{constructor(){super(["visible"]);let e,t;typeof document<"u"&&typeof document.addEventListener<"u"&&(typeof document.hidden<"u"?(t="visibilitychange",e="hidden"):typeof document.mozHidden<"u"?(t="mozvisibilitychange",e="mozHidden"):typeof document.msHidden<"u"?(t="msvisibilitychange",e="msHidden"):typeof document.webkitHidden<"u"&&(t="webkitvisibilitychange",e="webkitHidden")),this.visible_=!0,t&&document.addEventListener(t,()=>{const i=!document[e];i!==this.visible_&&(this.visible_=i,this.trigger("visible",i))},!1)}static getInstance(){return new pn}getInitialEvent(e){return m(e==="visible","Unknown event type: "+e),[this.visible_]}}const We=1e3,Ao=60*5*1e3,si=30*1e3,Mo=1.3,Oo=3e4,Lo="server_kill",ri=3;class re extends Ki{constructor(e,t,i,s,r,o,l,c){if(super(),this.repoInfo_=e,this.applicationId_=t,this.onDataUpdate_=i,this.onConnectStatus_=s,this.onServerInfoUpdate_=r,this.authTokenProvider_=o,this.appCheckTokenProvider_=l,this.authOverride_=c,this.id=re.nextPersistentConnectionId_++,this.log_=st("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=We,this.maxReconnectDelay_=Ao,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,c&&!wi())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");pn.getInstance().on("visible",this.onVisible_,this),e.host.indexOf("fblocal")===-1&&gt.getInstance().on("online",this.onOnline_,this)}sendRequest(e,t,i){const s=++this.requestNumber_,r={r:s,a:e,b:t};this.log_(V(r)),m(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(r),i&&(this.requestCBHash_[s]=i)}get(e){this.initConnection_();const t=new un,s={action:"g",request:{p:e._path.toString(),q:e._queryObject},onComplete:o=>{const l=o.d;o.s==="ok"?t.resolve(l):t.reject(l)}};this.outstandingGets_.push(s),this.outstandingGetCount_++;const r=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(r),t.promise}listen(e,t,i,s){this.initConnection_();const r=e._queryIdentifier,o=e._path.toString();this.log_("Listen called for "+o+" "+r),this.listens.has(o)||this.listens.set(o,new Map),m(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),"listen() called for non-default but complete query"),m(!this.listens.get(o).has(r),"listen() called twice for same path/queryId.");const l={onComplete:s,hashFn:t,query:e,tag:i};this.listens.get(o).set(r,l),this.connected_&&this.sendListen_(l)}sendGet_(e){const t=this.outstandingGets_[e];this.sendRequest("g",t.request,i=>{delete this.outstandingGets_[e],this.outstandingGetCount_--,this.outstandingGetCount_===0&&(this.outstandingGets_=[]),t.onComplete&&t.onComplete(i)})}sendListen_(e){const t=e.query,i=t._path.toString(),s=t._queryIdentifier;this.log_("Listen on "+i+" for "+s);const r={p:i},o="q";e.tag&&(r.q=t._queryObject,r.t=e.tag),r.h=e.hashFn(),this.sendRequest(o,r,l=>{const c=l.d,a=l.s;re.warnOnListenWarnings_(c,t),(this.listens.get(i)&&this.listens.get(i).get(s))===e&&(this.log_("listen response",l),a!=="ok"&&this.removeListen_(i,s),e.onComplete&&e.onComplete(a,c))})}static warnOnListenWarnings_(e,t){if(e&&typeof e=="object"&&le(e,"w")){const i=Pe(e,"w");if(Array.isArray(i)&&~i.indexOf("no_index")){const s='".indexOn": "'+t._queryParams.getIndex().toString()+'"',r=t._path.toString();Q(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${s} at ${r} to your security rules for better performance.`)}}}refreshAuthToken(e){this.authToken_=e,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(e)}reduceReconnectDelayIfAdminCredential_(e){(e&&e.length===40||ar(e))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=si)}refreshAppCheckToken(e){this.appCheckToken_=e,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){const e=this.authToken_,t=cr(e)?"auth":"gauth",i={cred:e};this.authOverride_===null?i.noauth=!0:typeof this.authOverride_=="object"&&(i.authvar=this.authOverride_),this.sendRequest(t,i,s=>{const r=s.s,o=s.d||"error";this.authToken_===e&&(r==="ok"?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(r,o))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},e=>{const t=e.s,i=e.d||"error";t==="ok"?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(t,i)})}unlisten(e,t){const i=e._path.toString(),s=e._queryIdentifier;this.log_("Unlisten called for "+i+" "+s),m(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(i,s)&&this.connected_&&this.sendUnlisten_(i,s,e._queryObject,t)}sendUnlisten_(e,t,i,s){this.log_("Unlisten on "+e+" for "+t);const r={p:e},o="n";s&&(r.q=i,r.t=s),this.sendRequest(o,r)}onDisconnectPut(e,t,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",e,t,i):this.onDisconnectRequestQueue_.push({pathString:e,action:"o",data:t,onComplete:i})}onDisconnectMerge(e,t,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",e,t,i):this.onDisconnectRequestQueue_.push({pathString:e,action:"om",data:t,onComplete:i})}onDisconnectCancel(e,t){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",e,null,t):this.onDisconnectRequestQueue_.push({pathString:e,action:"oc",data:null,onComplete:t})}sendOnDisconnect_(e,t,i,s){const r={p:t,d:i};this.log_("onDisconnect "+e,r),this.sendRequest(e,r,o=>{s&&setTimeout(()=>{s(o.s,o.d)},Math.floor(0))})}put(e,t,i,s){this.putInternal("p",e,t,i,s)}merge(e,t,i,s){this.putInternal("m",e,t,i,s)}putInternal(e,t,i,s,r){this.initConnection_();const o={p:t,d:i};r!==void 0&&(o.h=r),this.outstandingPuts_.push({action:e,request:o,onComplete:s}),this.outstandingPutCount_++;const l=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(l):this.log_("Buffering put: "+t)}sendPut_(e){const t=this.outstandingPuts_[e].action,i=this.outstandingPuts_[e].request,s=this.outstandingPuts_[e].onComplete;this.outstandingPuts_[e].queued=this.connected_,this.sendRequest(t,i,r=>{this.log_(t+" response",r),delete this.outstandingPuts_[e],this.outstandingPutCount_--,this.outstandingPutCount_===0&&(this.outstandingPuts_=[]),s&&s(r.s,r.d)})}reportStats(e){if(this.connected_){const t={c:e};this.log_("reportStats",t),this.sendRequest("s",t,i=>{if(i.s!=="ok"){const r=i.d;this.log_("reportStats","Error sending stats: "+r)}})}}onDataMessage_(e){if("r"in e){this.log_("from server: "+V(e));const t=e.r,i=this.requestCBHash_[t];i&&(delete this.requestCBHash_[t],i(e.b))}else{if("error"in e)throw"A server-side error has occurred: "+e.error;"a"in e&&this.onDataPush_(e.a,e.b)}}onDataPush_(e,t){this.log_("handleServerMessage",e,t),e==="d"?this.onDataUpdate_(t.p,t.d,!1,t.t):e==="m"?this.onDataUpdate_(t.p,t.d,!0,t.t):e==="c"?this.onListenRevoked_(t.p,t.q):e==="ac"?this.onAuthRevoked_(t.s,t.d):e==="apc"?this.onAppCheckRevoked_(t.s,t.d):e==="sd"?this.onSecurityDebugPacket_(t):Qt("Unrecognized action received from server: "+V(e)+`
Are you using the latest client?`)}onReady_(e,t){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(e),this.lastSessionId=t,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(e){m(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(e))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(e){e&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=We,this.realtime_||this.scheduleConnect_(0)),this.visible_=e}onOnline_(e){e?(this.log_("Browser went online."),this.reconnectDelay_=We,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&(new Date().getTime()-this.lastConnectionEstablishedTime_>Oo&&(this.reconnectDelay_=We),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime());const e=new Date().getTime()-this.lastConnectionAttemptTime_;let t=Math.max(0,this.reconnectDelay_-e);t=Math.random()*t,this.log_("Trying to reconnect in "+t+"ms"),this.scheduleConnect_(t),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*Mo)}this.onConnectStatus_(!1)}async establishConnection_(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;const e=this.onDataMessage_.bind(this),t=this.onReady_.bind(this),i=this.onRealtimeDisconnect_.bind(this),s=this.id+":"+re.nextConnectionId_++,r=this.lastSessionId;let o=!1,l=null;const c=function(){l?l.close():(o=!0,i())},a=function(d){m(l,"sendRequest call when we're not connected not allowed."),l.sendRequest(d)};this.realtime_={close:c,sendRequest:a};const u=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{const[d,_]=await Promise.all([this.authTokenProvider_.getToken(u),this.appCheckTokenProvider_.getToken(u)]);o?j("getToken() completed but was canceled"):(j("getToken() completed. Creating connection."),this.authToken_=d&&d.accessToken,this.appCheckToken_=_&&_.token,l=new xo(s,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,e,t,i,f=>{Q(f+" ("+this.repoInfo_.toString()+")"),this.interrupt(Lo)},r))}catch(d){this.log_("Failed to get token: "+d),o||(this.repoInfo_.nodeAdmin&&Q(d),c())}}}interrupt(e){j("Interrupting connection for reason: "+e),this.interruptReasons_[e]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(e){j("Resuming connection for reason: "+e),delete this.interruptReasons_[e],Hn(this.interruptReasons_)&&(this.reconnectDelay_=We,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(e){const t=e-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:t})}cancelSentTransactions_(){for(let e=0;e<this.outstandingPuts_.length;e++){const t=this.outstandingPuts_[e];t&&"h"in t.request&&t.queued&&(t.onComplete&&t.onComplete("disconnect"),delete this.outstandingPuts_[e],this.outstandingPutCount_--)}this.outstandingPutCount_===0&&(this.outstandingPuts_=[])}onListenRevoked_(e,t){let i;t?i=t.map(r=>hn(r)).join("$"):i="default";const s=this.removeListen_(e,i);s&&s.onComplete&&s.onComplete("permission_denied")}removeListen_(e,t){const i=new M(e).toString();let s;if(this.listens.has(i)){const r=this.listens.get(i);s=r.get(t),r.delete(t),r.size===0&&this.listens.delete(i)}else s=void 0;return s}onAuthRevoked_(e,t){j("Auth token revoked: "+e+"/"+t),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),(e==="invalid_token"||e==="permission_denied")&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=ri&&(this.reconnectDelay_=si,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(e,t){j("App check token revoked: "+e+"/"+t),this.appCheckToken_=null,this.forceTokenRefresh_=!0,(e==="invalid_token"||e==="permission_denied")&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=ri&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(e){this.securityDebugCallback_?this.securityDebugCallback_(e):"msg"in e&&console.log("FIREBASE: "+e.msg.replace(`
`,`
FIREBASE: `))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(const e of this.listens.values())for(const t of e.values())this.sendListen_(t);for(let e=0;e<this.outstandingPuts_.length;e++)this.outstandingPuts_[e]&&this.sendPut_(e);for(;this.onDisconnectRequestQueue_.length;){const e=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(e.action,e.pathString,e.data,e.onComplete)}for(let e=0;e<this.outstandingGets_.length;e++)this.outstandingGets_[e]&&this.sendGet_(e)}sendConnectStats_(){const e={};let t="js";e["sdk."+t+"."+bi.replace(/\./g,"-")]=1,Si()?e["framework.cordova"]=1:ur()&&(e["framework.reactnative"]=1),this.reportStats(e)}shouldReconnect_(){const e=gt.getInstance().currentlyOnline();return Hn(this.interruptReasons_)&&e}}re.nextPersistentConnectionId_=0;re.nextConnectionId_=0;class x{constructor(e,t){this.name=e,this.node=t}static Wrap(e,t){return new x(e,t)}}class Pt{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){const i=new x(Re,e),s=new x(Re,t);return this.compare(i,s)!==0}minPost(){return x.MIN}}let dt;class ts extends Pt{static get __EMPTY_NODE(){return dt}static set __EMPTY_NODE(e){dt=e}compare(e,t){return Oe(e.name,t.name)}isDefinedOn(e){throw nt("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(e,t){return!1}minPost(){return x.MIN}maxPost(){return new x(ye,dt)}makePost(e,t){return m(typeof e=="string","KeyIndex indexValue must always be a string."),new x(e,dt)}toString(){return".key"}}const Ne=new ts;class ft{constructor(e,t,i,s,r=null){this.isReverse_=s,this.resultGenerator_=r,this.nodeStack_=[];let o=1;for(;!e.isEmpty();)if(e=e,o=t?i(e.key,t):1,s&&(o*=-1),o<0)this.isReverse_?e=e.left:e=e.right;else if(o===0){this.nodeStack_.push(e);break}else this.nodeStack_.push(e),this.isReverse_?e=e.right:e=e.left}getNext(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_.pop(),t;if(this.resultGenerator_?t=this.resultGenerator_(e.key,e.value):t={key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return t}hasNext(){return this.nodeStack_.length>0}peek(){if(this.nodeStack_.length===0)return null;const e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}}class z{constructor(e,t,i,s,r){this.key=e,this.value=t,this.color=i??z.RED,this.left=s??$.EMPTY_NODE,this.right=r??$.EMPTY_NODE}copy(e,t,i,s,r){return new z(e??this.key,t??this.value,i??this.color,s??this.left,r??this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||!!e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,i){let s=this;const r=i(e,s.key);return r<0?s=s.copy(null,null,null,s.left.insert(e,t,i),null):r===0?s=s.copy(null,t,null,null,null):s=s.copy(null,null,null,null,s.right.insert(e,t,i)),s.fixUp_()}removeMin_(){if(this.left.isEmpty())return $.EMPTY_NODE;let e=this;return!e.left.isRed_()&&!e.left.left.isRed_()&&(e=e.moveRedLeft_()),e=e.copy(null,null,null,e.left.removeMin_(),null),e.fixUp_()}remove(e,t){let i,s;if(i=this,t(e,i.key)<0)!i.left.isEmpty()&&!i.left.isRed_()&&!i.left.left.isRed_()&&(i=i.moveRedLeft_()),i=i.copy(null,null,null,i.left.remove(e,t),null);else{if(i.left.isRed_()&&(i=i.rotateRight_()),!i.right.isEmpty()&&!i.right.isRed_()&&!i.right.left.isRed_()&&(i=i.moveRedRight_()),t(e,i.key)===0){if(i.right.isEmpty())return $.EMPTY_NODE;s=i.right.min_(),i=i.copy(s.key,s.value,null,null,i.right.removeMin_())}i=i.copy(null,null,null,null,i.right.remove(e,t))}return i.fixUp_()}isRed_(){return this.color}fixUp_(){let e=this;return e.right.isRed_()&&!e.left.isRed_()&&(e=e.rotateLeft_()),e.left.isRed_()&&e.left.left.isRed_()&&(e=e.rotateRight_()),e.left.isRed_()&&e.right.isRed_()&&(e=e.colorFlip_()),e}moveRedLeft_(){let e=this.colorFlip_();return e.right.left.isRed_()&&(e=e.copy(null,null,null,null,e.right.rotateRight_()),e=e.rotateLeft_(),e=e.colorFlip_()),e}moveRedRight_(){let e=this.colorFlip_();return e.left.left.isRed_()&&(e=e.rotateRight_(),e=e.colorFlip_()),e}rotateLeft_(){const e=this.copy(null,null,z.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight_(){const e=this.copy(null,null,z.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip_(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth_(){const e=this.check_();return Math.pow(2,e)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");const e=this.left.check_();if(e!==this.right.check_())throw new Error("Black depths differ");return e+(this.isRed_()?0:1)}}z.RED=!0;z.BLACK=!1;class Do{copy(e,t,i,s,r){return this}insert(e,t,i){return new z(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}}class ${constructor(e,t=$.EMPTY_NODE){this.comparator_=e,this.root_=t}insert(e,t){return new $(this.comparator_,this.root_.insert(e,t,this.comparator_).copy(null,null,z.BLACK,null,null))}remove(e){return new $(this.comparator_,this.root_.remove(e,this.comparator_).copy(null,null,z.BLACK,null,null))}get(e){let t,i=this.root_;for(;!i.isEmpty();){if(t=this.comparator_(e,i.key),t===0)return i.value;t<0?i=i.left:t>0&&(i=i.right)}return null}getPredecessorKey(e){let t,i=this.root_,s=null;for(;!i.isEmpty();)if(t=this.comparator_(e,i.key),t===0){if(i.left.isEmpty())return s?s.key:null;for(i=i.left;!i.right.isEmpty();)i=i.right;return i.key}else t<0?i=i.left:t>0&&(s=i,i=i.right);throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new ft(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new ft(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new ft(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new ft(this.root_,null,this.comparator_,!0,e)}}$.EMPTY_NODE=new Do;function Fo(n,e){return Oe(n.name,e.name)}function gn(n,e){return Oe(n,e)}let Jt;function Wo(n){Jt=n}const ns=function(n){return typeof n=="number"?"number:"+ki(n):"string:"+n},is=function(n){if(n.isLeafNode()){const e=n.val();m(typeof e=="string"||typeof e=="number"||typeof e=="object"&&le(e,".sv"),"Priority must be a string or number.")}else m(n===Jt||n.isEmpty(),"priority of unexpected type.");m(n===Jt||n.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};let oi;class q{constructor(e,t=q.__childrenNodeConstructor.EMPTY_NODE){this.value_=e,this.priorityNode_=t,this.lazyHash_=null,m(this.value_!==void 0&&this.value_!==null,"LeafNode shouldn't be created with null/undefined value."),is(this.priorityNode_)}static set __childrenNodeConstructor(e){oi=e}static get __childrenNodeConstructor(){return oi}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(e){return new q(this.value_,e)}getImmediateChild(e){return e===".priority"?this.priorityNode_:q.__childrenNodeConstructor.EMPTY_NODE}getChild(e){return N(e)?this:R(e)===".priority"?this.priorityNode_:q.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(e,t){return null}updateImmediateChild(e,t){return e===".priority"?this.updatePriority(t):t.isEmpty()&&e!==".priority"?this:q.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(e,t).updatePriority(this.priorityNode_)}updateChild(e,t){const i=R(e);return i===null?t:t.isEmpty()&&i!==".priority"?this:(m(i!==".priority"||de(e)===1,".priority must be the last token in a path"),this.updateImmediateChild(i,q.__childrenNodeConstructor.EMPTY_NODE.updateChild(L(e),t)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(e,t){return!1}val(e){return e&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(this.lazyHash_===null){let e="";this.priorityNode_.isEmpty()||(e+="priority:"+ns(this.priorityNode_.val())+":");const t=typeof this.value_;e+=t+":",t==="number"?e+=ki(this.value_):e+=this.value_,this.lazyHash_=Ni(e)}return this.lazyHash_}getValue(){return this.value_}compareTo(e){return e===q.__childrenNodeConstructor.EMPTY_NODE?1:e instanceof q.__childrenNodeConstructor?-1:(m(e.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(e))}compareToLeafNode_(e){const t=typeof e.value_,i=typeof this.value_,s=q.VALUE_TYPE_ORDER.indexOf(t),r=q.VALUE_TYPE_ORDER.indexOf(i);return m(s>=0,"Unknown leaf type: "+t),m(r>=0,"Unknown leaf type: "+i),s===r?i==="object"?0:this.value_<e.value_?-1:this.value_===e.value_?0:1:r-s}withIndex(){return this}isIndexed(){return!0}equals(e){if(e===this)return!0;if(e.isLeafNode()){const t=e;return this.value_===t.value_&&this.priorityNode_.equals(t.priorityNode_)}else return!1}}q.VALUE_TYPE_ORDER=["object","boolean","number","string"];let ss,rs;function Bo(n){ss=n}function Uo(n){rs=n}class Ho extends Pt{compare(e,t){const i=e.node.getPriority(),s=t.node.getPriority(),r=i.compareTo(s);return r===0?Oe(e.name,t.name):r}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return x.MIN}maxPost(){return new x(ye,new q("[PRIORITY-POST]",rs))}makePost(e,t){const i=ss(e);return new x(t,new q("[PRIORITY-POST]",i))}toString(){return".priority"}}const B=new Ho;const Vo=Math.log(2);class Go{constructor(e){const t=r=>parseInt(Math.log(r)/Vo,10),i=r=>parseInt(Array(r+1).join("1"),2);this.count=t(e+1),this.current_=this.count-1;const s=i(this.count);this.bits_=e+1&s}nextBitIsOne(){const e=!(this.bits_&1<<this.current_);return this.current_--,e}}const mt=function(n,e,t,i){n.sort(e);const s=function(c,a){const u=a-c;let d,_;if(u===0)return null;if(u===1)return d=n[c],_=t?t(d):d,new z(_,d.node,z.BLACK,null,null);{const f=parseInt(u/2,10)+c,h=s(c,f),p=s(f+1,a);return d=n[f],_=t?t(d):d,new z(_,d.node,z.BLACK,h,p)}},r=function(c){let a=null,u=null,d=n.length;const _=function(h,p){const g=d-h,y=d;d-=h;const T=s(g+1,y),W=n[g],v=t?t(W):W;f(new z(v,W.node,p,null,T))},f=function(h){a?(a.left=h,a=h):(u=h,a=h)};for(let h=0;h<c.count;++h){const p=c.nextBitIsOne(),g=Math.pow(2,c.count-(h+1));p?_(g,z.BLACK):(_(g,z.BLACK),_(g,z.RED))}return u},o=new Go(n.length),l=r(o);return new $(i||e,l)};let Vt;const we={};class se{constructor(e,t){this.indexes_=e,this.indexSet_=t}static get Default(){return m(we&&B,"ChildrenNode.ts has not been loaded"),Vt=Vt||new se({".priority":we},{".priority":B}),Vt}get(e){const t=Pe(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof $?t:null}hasIndex(e){return le(this.indexSet_,e.toString())}addIndex(e,t){m(e!==Ne,"KeyIndex always exists and isn't meant to be added to the IndexMap.");const i=[];let s=!1;const r=t.getIterator(x.Wrap);let o=r.getNext();for(;o;)s=s||e.isDefinedOn(o.node),i.push(o),o=r.getNext();let l;s?l=mt(i,e.getCompare()):l=we;const c=e.toString(),a=Object.assign({},this.indexSet_);a[c]=e;const u=Object.assign({},this.indexes_);return u[c]=l,new se(u,a)}addToIndexes(e,t){const i=_t(this.indexes_,(s,r)=>{const o=Pe(this.indexSet_,r);if(m(o,"Missing index implementation for "+r),s===we)if(o.isDefinedOn(e.node)){const l=[],c=t.getIterator(x.Wrap);let a=c.getNext();for(;a;)a.name!==e.name&&l.push(a),a=c.getNext();return l.push(e),mt(l,o.getCompare())}else return we;else{const l=t.get(e.name);let c=s;return l&&(c=c.remove(new x(e.name,l))),c.insert(e,e.node)}});return new se(i,this.indexSet_)}removeFromIndexes(e,t){const i=_t(this.indexes_,s=>{if(s===we)return s;{const r=t.get(e.name);return r?s.remove(new x(e.name,r)):s}});return new se(i,this.indexSet_)}}let Be;class I{constructor(e,t,i){this.children_=e,this.priorityNode_=t,this.indexMap_=i,this.lazyHash_=null,this.priorityNode_&&is(this.priorityNode_),this.children_.isEmpty()&&m(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}static get EMPTY_NODE(){return Be||(Be=new I(new $(gn),null,se.Default))}isLeafNode(){return!1}getPriority(){return this.priorityNode_||Be}updatePriority(e){return this.children_.isEmpty()?this:new I(this.children_,e,this.indexMap_)}getImmediateChild(e){if(e===".priority")return this.getPriority();{const t=this.children_.get(e);return t===null?Be:t}}getChild(e){const t=R(e);return t===null?this:this.getImmediateChild(t).getChild(L(e))}hasChild(e){return this.children_.get(e)!==null}updateImmediateChild(e,t){if(m(t,"We should always be passing snapshot nodes"),e===".priority")return this.updatePriority(t);{const i=new x(e,t);let s,r;t.isEmpty()?(s=this.children_.remove(e),r=this.indexMap_.removeFromIndexes(i,this.children_)):(s=this.children_.insert(e,t),r=this.indexMap_.addToIndexes(i,this.children_));const o=s.isEmpty()?Be:this.priorityNode_;return new I(s,o,r)}}updateChild(e,t){const i=R(e);if(i===null)return t;{m(R(e)!==".priority"||de(e)===1,".priority must be the last token in a path");const s=this.getImmediateChild(i).updateChild(L(e),t);return this.updateImmediateChild(i,s)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(e){if(this.isEmpty())return null;const t={};let i=0,s=0,r=!0;if(this.forEachChild(B,(o,l)=>{t[o]=l.val(e),i++,r&&I.INTEGER_REGEXP_.test(o)?s=Math.max(s,Number(o)):r=!1}),!e&&r&&s<2*i){const o=[];for(const l in t)o[l]=t[l];return o}else return e&&!this.getPriority().isEmpty()&&(t[".priority"]=this.getPriority().val()),t}hash(){if(this.lazyHash_===null){let e="";this.getPriority().isEmpty()||(e+="priority:"+ns(this.getPriority().val())+":"),this.forEachChild(B,(t,i)=>{const s=i.hash();s!==""&&(e+=":"+t+":"+s)}),this.lazyHash_=e===""?"":Ni(e)}return this.lazyHash_}getPredecessorChildName(e,t,i){const s=this.resolveIndex_(i);if(s){const r=s.getPredecessorKey(new x(e,t));return r?r.name:null}else return this.children_.getPredecessorKey(e)}getFirstChildName(e){const t=this.resolveIndex_(e);if(t){const i=t.minKey();return i&&i.name}else return this.children_.minKey()}getFirstChild(e){const t=this.getFirstChildName(e);return t?new x(t,this.children_.get(t)):null}getLastChildName(e){const t=this.resolveIndex_(e);if(t){const i=t.maxKey();return i&&i.name}else return this.children_.maxKey()}getLastChild(e){const t=this.getLastChildName(e);return t?new x(t,this.children_.get(t)):null}forEachChild(e,t){const i=this.resolveIndex_(e);return i?i.inorderTraversal(s=>t(s.name,s.node)):this.children_.inorderTraversal(t)}getIterator(e){return this.getIteratorFrom(e.minPost(),e)}getIteratorFrom(e,t){const i=this.resolveIndex_(t);if(i)return i.getIteratorFrom(e,s=>s);{const s=this.children_.getIteratorFrom(e.name,x.Wrap);let r=s.peek();for(;r!=null&&t.compare(r,e)<0;)s.getNext(),r=s.peek();return s}}getReverseIterator(e){return this.getReverseIteratorFrom(e.maxPost(),e)}getReverseIteratorFrom(e,t){const i=this.resolveIndex_(t);if(i)return i.getReverseIteratorFrom(e,s=>s);{const s=this.children_.getReverseIteratorFrom(e.name,x.Wrap);let r=s.peek();for(;r!=null&&t.compare(r,e)>0;)s.getNext(),r=s.peek();return s}}compareTo(e){return this.isEmpty()?e.isEmpty()?0:-1:e.isLeafNode()||e.isEmpty()?1:e===rt?-1:0}withIndex(e){if(e===Ne||this.indexMap_.hasIndex(e))return this;{const t=this.indexMap_.addIndex(e,this.children_);return new I(this.children_,this.priorityNode_,t)}}isIndexed(e){return e===Ne||this.indexMap_.hasIndex(e)}equals(e){if(e===this)return!0;if(e.isLeafNode())return!1;{const t=e;if(this.getPriority().equals(t.getPriority()))if(this.children_.count()===t.children_.count()){const i=this.getIterator(B),s=t.getIterator(B);let r=i.getNext(),o=s.getNext();for(;r&&o;){if(r.name!==o.name||!r.node.equals(o.node))return!1;r=i.getNext(),o=s.getNext()}return r===null&&o===null}else return!1;else return!1}}resolveIndex_(e){return e===Ne?null:this.indexMap_.get(e.toString())}}I.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/;class qo extends I{constructor(){super(new $(gn),I.EMPTY_NODE,se.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return I.EMPTY_NODE}isEmpty(){return!1}}const rt=new qo;Object.defineProperties(x,{MIN:{value:new x(Re,I.EMPTY_NODE)},MAX:{value:new x(ye,rt)}});ts.__EMPTY_NODE=I.EMPTY_NODE;q.__childrenNodeConstructor=I;Wo(rt);Uo(rt);const zo=!0;function Y(n,e=null){if(n===null)return I.EMPTY_NODE;if(typeof n=="object"&&".priority"in n&&(e=n[".priority"]),m(e===null||typeof e=="string"||typeof e=="number"||typeof e=="object"&&".sv"in e,"Invalid priority type found: "+typeof e),typeof n=="object"&&".value"in n&&n[".value"]!==null&&(n=n[".value"]),typeof n!="object"||".sv"in n){const t=n;return new q(t,Y(e))}if(!(n instanceof Array)&&zo){const t=[];let i=!1;if(X(n,(o,l)=>{if(o.substring(0,1)!=="."){const c=Y(l);c.isEmpty()||(i=i||!c.getPriority().isEmpty(),t.push(new x(o,c)))}}),t.length===0)return I.EMPTY_NODE;const r=mt(t,Fo,o=>o.name,gn);if(i){const o=mt(t,B.getCompare());return new I(r,Y(e),new se({".priority":o},{".priority":B}))}else return new I(r,Y(e),se.Default)}else{let t=I.EMPTY_NODE;return X(n,(i,s)=>{if(le(n,i)&&i.substring(0,1)!=="."){const r=Y(s);(r.isLeafNode()||!r.isEmpty())&&(t=t.updateImmediateChild(i,r))}}),t.updatePriority(Y(e))}}Bo(Y);class Yo extends Pt{constructor(e){super(),this.indexPath_=e,m(!N(e)&&R(e)!==".priority","Can't create PathIndex with empty path or .priority key")}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){const i=this.extractChild(e.node),s=this.extractChild(t.node),r=i.compareTo(s);return r===0?Oe(e.name,t.name):r}makePost(e,t){const i=Y(e),s=I.EMPTY_NODE.updateChild(this.indexPath_,i);return new x(t,s)}maxPost(){const e=I.EMPTY_NODE.updateChild(this.indexPath_,rt);return new x(ye,e)}toString(){return Xi(this.indexPath_,0).join("/")}}class jo extends Pt{compare(e,t){const i=e.node.compareTo(t.node);return i===0?Oe(e.name,t.name):i}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return x.MIN}maxPost(){return x.MAX}makePost(e,t){const i=Y(e);return new x(t,i)}toString(){return".value"}}const Ko=new jo;function os(n){return{type:"value",snapshotNode:n}}function ke(n,e){return{type:"child_added",snapshotNode:e,childName:n}}function je(n,e){return{type:"child_removed",snapshotNode:e,childName:n}}function Ke(n,e,t){return{type:"child_changed",snapshotNode:e,childName:n,oldSnap:t}}function $o(n,e){return{type:"child_moved",snapshotNode:e,childName:n}}class mn{constructor(e){this.index_=e}updateChild(e,t,i,s,r,o){m(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");const l=e.getImmediateChild(t);return l.getChild(s).equals(i.getChild(s))&&l.isEmpty()===i.isEmpty()||(o!=null&&(i.isEmpty()?e.hasChild(t)?o.trackChildChange(je(t,l)):m(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):l.isEmpty()?o.trackChildChange(ke(t,i)):o.trackChildChange(Ke(t,i,l))),e.isLeafNode()&&i.isEmpty())?e:e.updateImmediateChild(t,i).withIndex(this.index_)}updateFullNode(e,t,i){return i!=null&&(e.isLeafNode()||e.forEachChild(B,(s,r)=>{t.hasChild(s)||i.trackChildChange(je(s,r))}),t.isLeafNode()||t.forEachChild(B,(s,r)=>{if(e.hasChild(s)){const o=e.getImmediateChild(s);o.equals(r)||i.trackChildChange(Ke(s,r,o))}else i.trackChildChange(ke(s,r))})),t.withIndex(this.index_)}updatePriority(e,t){return e.isEmpty()?I.EMPTY_NODE:e.updatePriority(t)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}}class $e{constructor(e){this.indexedFilter_=new mn(e.getIndex()),this.index_=e.getIndex(),this.startPost_=$e.getStartPost_(e),this.endPost_=$e.getEndPost_(e),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){const t=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,i=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return t&&i}updateChild(e,t,i,s,r,o){return this.matches(new x(t,i))||(i=I.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,i,s,r,o)}updateFullNode(e,t,i){t.isLeafNode()&&(t=I.EMPTY_NODE);let s=t.withIndex(this.index_);s=s.updatePriority(I.EMPTY_NODE);const r=this;return t.forEachChild(B,(o,l)=>{r.matches(new x(o,l))||(s=s.updateImmediateChild(o,I.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(e,s,i)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){const t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}else return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){const t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}else return e.getIndex().maxPost()}}class Qo{constructor(e){this.withinDirectionalStart=t=>this.reverse_?this.withinEndPost(t):this.withinStartPost(t),this.withinDirectionalEnd=t=>this.reverse_?this.withinStartPost(t):this.withinEndPost(t),this.withinStartPost=t=>{const i=this.index_.compare(this.rangedFilter_.getStartPost(),t);return this.startIsInclusive_?i<=0:i<0},this.withinEndPost=t=>{const i=this.index_.compare(t,this.rangedFilter_.getEndPost());return this.endIsInclusive_?i<=0:i<0},this.rangedFilter_=new $e(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,t,i,s,r,o){return this.rangedFilter_.matches(new x(t,i))||(i=I.EMPTY_NODE),e.getImmediateChild(t).equals(i)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,i,s,r,o):this.fullLimitUpdateChild_(e,t,i,r,o)}updateFullNode(e,t,i){let s;if(t.isLeafNode()||t.isEmpty())s=I.EMPTY_NODE.withIndex(this.index_);else if(this.limit_*2<t.numChildren()&&t.isIndexed(this.index_)){s=I.EMPTY_NODE.withIndex(this.index_);let r;this.reverse_?r=t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):r=t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let o=0;for(;r.hasNext()&&o<this.limit_;){const l=r.getNext();if(this.withinDirectionalStart(l))if(this.withinDirectionalEnd(l))s=s.updateImmediateChild(l.name,l.node),o++;else break;else continue}}else{s=t.withIndex(this.index_),s=s.updatePriority(I.EMPTY_NODE);let r;this.reverse_?r=s.getReverseIterator(this.index_):r=s.getIterator(this.index_);let o=0;for(;r.hasNext();){const l=r.getNext();o<this.limit_&&this.withinDirectionalStart(l)&&this.withinDirectionalEnd(l)?o++:s=s.updateImmediateChild(l.name,I.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,s,i)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,t,i,s,r){let o;if(this.reverse_){const d=this.index_.getCompare();o=(_,f)=>d(f,_)}else o=this.index_.getCompare();const l=e;m(l.numChildren()===this.limit_,"");const c=new x(t,i),a=this.reverse_?l.getFirstChild(this.index_):l.getLastChild(this.index_),u=this.rangedFilter_.matches(c);if(l.hasChild(t)){const d=l.getImmediateChild(t);let _=s.getChildAfterChild(this.index_,a,this.reverse_);for(;_!=null&&(_.name===t||l.hasChild(_.name));)_=s.getChildAfterChild(this.index_,_,this.reverse_);const f=_==null?1:o(_,c);if(u&&!i.isEmpty()&&f>=0)return r!=null&&r.trackChildChange(Ke(t,i,d)),l.updateImmediateChild(t,i);{r!=null&&r.trackChildChange(je(t,d));const p=l.updateImmediateChild(t,I.EMPTY_NODE);return _!=null&&this.rangedFilter_.matches(_)?(r!=null&&r.trackChildChange(ke(_.name,_.node)),p.updateImmediateChild(_.name,_.node)):p}}else return i.isEmpty()?e:u&&o(a,c)>=0?(r!=null&&(r.trackChildChange(je(a.name,a.node)),r.trackChildChange(ke(t,i))),l.updateImmediateChild(t,i).updateImmediateChild(a.name,I.EMPTY_NODE)):e}}class vn{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=B}hasStart(){return this.startSet_}isViewFromLeft(){return this.viewFrom_===""?this.startSet_:this.viewFrom_==="l"}getIndexStartValue(){return m(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return m(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:Re}hasEnd(){return this.endSet_}getIndexEndValue(){return m(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return m(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:ye}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&this.viewFrom_!==""}getLimit(){return m(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===B}copy(){const e=new vn;return e.limitSet_=this.limitSet_,e.limit_=this.limit_,e.startSet_=this.startSet_,e.startAfterSet_=this.startAfterSet_,e.indexStartValue_=this.indexStartValue_,e.startNameSet_=this.startNameSet_,e.indexStartName_=this.indexStartName_,e.endSet_=this.endSet_,e.endBeforeSet_=this.endBeforeSet_,e.indexEndValue_=this.indexEndValue_,e.endNameSet_=this.endNameSet_,e.indexEndName_=this.indexEndName_,e.index_=this.index_,e.viewFrom_=this.viewFrom_,e}}function Xo(n){return n.loadsAllData()?new mn(n.getIndex()):n.hasLimit()?new Qo(n):new $e(n)}function li(n){const e={};if(n.isDefault())return e;let t;if(n.index_===B?t="$priority":n.index_===Ko?t="$value":n.index_===Ne?t="$key":(m(n.index_ instanceof Yo,"Unrecognized index type!"),t=n.index_.toString()),e.orderBy=V(t),n.startSet_){const i=n.startAfterSet_?"startAfter":"startAt";e[i]=V(n.indexStartValue_),n.startNameSet_&&(e[i]+=","+V(n.indexStartName_))}if(n.endSet_){const i=n.endBeforeSet_?"endBefore":"endAt";e[i]=V(n.indexEndValue_),n.endNameSet_&&(e[i]+=","+V(n.indexEndName_))}return n.limitSet_&&(n.isViewFromLeft()?e.limitToFirst=n.limit_:e.limitToLast=n.limit_),e}function ai(n){const e={};if(n.startSet_&&(e.sp=n.indexStartValue_,n.startNameSet_&&(e.sn=n.indexStartName_),e.sin=!n.startAfterSet_),n.endSet_&&(e.ep=n.indexEndValue_,n.endNameSet_&&(e.en=n.indexEndName_),e.ein=!n.endBeforeSet_),n.limitSet_){e.l=n.limit_;let t=n.viewFrom_;t===""&&(n.isViewFromLeft()?t="l":t="r"),e.vf=t}return n.index_!==B&&(e.i=n.index_.toString()),e}class vt extends Ki{constructor(e,t,i,s){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=i,this.appCheckTokenProvider_=s,this.log_=st("p:rest:"),this.listens_={}}reportStats(e){throw new Error("Method not implemented.")}static getListenId_(e,t){return t!==void 0?"tag$"+t:(m(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())}listen(e,t,i,s){const r=e._path.toString();this.log_("Listen called for "+r+" "+e._queryIdentifier);const o=vt.getListenId_(e,i),l={};this.listens_[o]=l;const c=li(e._queryParams);this.restRequest_(r+".json",c,(a,u)=>{let d=u;if(a===404&&(d=null,a=null),a===null&&this.onDataUpdate_(r,d,!1,i),Pe(this.listens_,o)===l){let _;a?a===401?_="permission_denied":_="rest_error:"+a:_="ok",s(_,null)}})}unlisten(e,t){const i=vt.getListenId_(e,t);delete this.listens_[i]}get(e){const t=li(e._queryParams),i=e._path.toString(),s=new un;return this.restRequest_(i+".json",t,(r,o)=>{let l=o;r===404&&(l=null,r=null),r===null?(this.onDataUpdate_(i,l,!1,null),s.resolve(l)):s.reject(new Error(l))}),s.promise}refreshAuthToken(e){}restRequest_(e,t={},i){return t.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([s,r])=>{s&&s.accessToken&&(t.auth=s.accessToken),r&&r.token&&(t.ac=r.token);const o=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+e+"?ns="+this.repoInfo_.namespace+hr(t);this.log_("Sending REST request for "+o);const l=new XMLHttpRequest;l.onreadystatechange=()=>{if(i&&l.readyState===4){this.log_("REST Response for "+o+" received. status:",l.status,"response:",l.responseText);let c=null;if(l.status>=200&&l.status<300){try{c=an(l.responseText)}catch{Q("Failed to parse JSON response for "+o+": "+l.responseText)}i(null,c)}else l.status!==401&&l.status!==404&&Q("Got unsuccessful REST response for "+o+" Status: "+l.status),i(l.status);i=null}},l.open("GET",o,!0),l.send()})}}class Jo{constructor(){this.rootNode_=I.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}}function yt(){return{value:null,children:new Map}}function ls(n,e,t){if(N(e))n.value=t,n.children.clear();else if(n.value!==null)n.value=n.value.updateChild(e,t);else{const i=R(e);n.children.has(i)||n.children.set(i,yt());const s=n.children.get(i);e=L(e),ls(s,e,t)}}function Zt(n,e,t){n.value!==null?t(e,n.value):Zo(n,(i,s)=>{const r=new M(e.toString()+"/"+i);Zt(s,r,t)})}function Zo(n,e){n.children.forEach((t,i)=>{e(i,t)})}class el{constructor(e){this.collection_=e,this.last_=null}get(){const e=this.collection_.get(),t=Object.assign({},e);return this.last_&&X(this.last_,(i,s)=>{t[i]=t[i]-s}),this.last_=e,t}}const ci=10*1e3,tl=30*1e3,nl=5*60*1e3;class il{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new el(e);const i=ci+(tl-ci)*Math.random();He(this.reportStats_.bind(this),Math.floor(i))}reportStats_(){const e=this.statsListener_.get(),t={};let i=!1;X(e,(s,r)=>{r>0&&le(this.statsToReport_,s)&&(t[s]=r,i=!0)}),i&&this.server_.reportStats(t),He(this.reportStats_.bind(this),Math.floor(Math.random()*2*nl))}}var te;(function(n){n[n.OVERWRITE=0]="OVERWRITE",n[n.MERGE=1]="MERGE",n[n.ACK_USER_WRITE=2]="ACK_USER_WRITE",n[n.LISTEN_COMPLETE=3]="LISTEN_COMPLETE"})(te||(te={}));function as(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function yn(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function Cn(n){return{fromUser:!1,fromServer:!0,queryId:n,tagged:!0}}class Ct{constructor(e,t,i){this.path=e,this.affectedTree=t,this.revert=i,this.type=te.ACK_USER_WRITE,this.source=as()}operationForChild(e){if(N(this.path)){if(this.affectedTree.value!=null)return m(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{const t=this.affectedTree.subtree(new M(e));return new Ct(k(),t,this.revert)}}else return m(R(this.path)===e,"operationForChild called for unrelated child."),new Ct(L(this.path),this.affectedTree,this.revert)}}class Qe{constructor(e,t){this.source=e,this.path=t,this.type=te.LISTEN_COMPLETE}operationForChild(e){return N(this.path)?new Qe(this.source,k()):new Qe(this.source,L(this.path))}}class Ce{constructor(e,t,i){this.source=e,this.path=t,this.snap=i,this.type=te.OVERWRITE}operationForChild(e){return N(this.path)?new Ce(this.source,k(),this.snap.getImmediateChild(e)):new Ce(this.source,L(this.path),this.snap)}}class Xe{constructor(e,t,i){this.source=e,this.path=t,this.children=i,this.type=te.MERGE}operationForChild(e){if(N(this.path)){const t=this.children.subtree(new M(e));return t.isEmpty()?null:t.value?new Ce(this.source,k(),t.value):new Xe(this.source,k(),t)}else return m(R(this.path)===e,"Can't get a merge for a child not on the path of the operation"),new Xe(this.source,L(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}}class fe{constructor(e,t,i){this.node_=e,this.fullyInitialized_=t,this.filtered_=i}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(N(e))return this.isFullyInitialized()&&!this.filtered_;const t=R(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}}class sl{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}}function rl(n,e,t,i){const s=[],r=[];return e.forEach(o=>{o.type==="child_changed"&&n.index_.indexedValueChanged(o.oldSnap,o.snapshotNode)&&r.push($o(o.childName,o.snapshotNode))}),Ue(n,s,"child_removed",e,i,t),Ue(n,s,"child_added",e,i,t),Ue(n,s,"child_moved",r,i,t),Ue(n,s,"child_changed",e,i,t),Ue(n,s,"value",e,i,t),s}function Ue(n,e,t,i,s,r){const o=i.filter(l=>l.type===t);o.sort((l,c)=>ll(n,l,c)),o.forEach(l=>{const c=ol(n,l,r);s.forEach(a=>{a.respondsTo(l.type)&&e.push(a.createEvent(c,n.query_))})})}function ol(n,e,t){return e.type==="value"||e.type==="child_removed"||(e.prevName=t.getPredecessorChildName(e.childName,e.snapshotNode,n.index_)),e}function ll(n,e,t){if(e.childName==null||t.childName==null)throw nt("Should only compare child_ events.");const i=new x(e.childName,e.snapshotNode),s=new x(t.childName,t.snapshotNode);return n.index_.compare(i,s)}function Rt(n,e){return{eventCache:n,serverCache:e}}function Ve(n,e,t,i){return Rt(new fe(e,t,i),n.serverCache)}function cs(n,e,t,i){return Rt(n.eventCache,new fe(e,t,i))}function Et(n){return n.eventCache.isFullyInitialized()?n.eventCache.getNode():null}function Ee(n){return n.serverCache.isFullyInitialized()?n.serverCache.getNode():null}let Gt;const al=()=>(Gt||(Gt=new $(Yr)),Gt);class F{constructor(e,t=al()){this.value=e,this.children=t}static fromObject(e){let t=new F(null);return X(e,(i,s)=>{t=t.set(new M(i),s)}),t}isEmpty(){return this.value===null&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(this.value!=null&&t(this.value))return{path:k(),value:this.value};if(N(e))return null;{const i=R(e),s=this.children.get(i);if(s!==null){const r=s.findRootMostMatchingPathAndValue(L(e),t);return r!=null?{path:G(new M(i),r.path),value:r.value}:null}else return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,()=>!0)}subtree(e){if(N(e))return this;{const t=R(e),i=this.children.get(t);return i!==null?i.subtree(L(e)):new F(null)}}set(e,t){if(N(e))return new F(t,this.children);{const i=R(e),r=(this.children.get(i)||new F(null)).set(L(e),t),o=this.children.insert(i,r);return new F(this.value,o)}}remove(e){if(N(e))return this.children.isEmpty()?new F(null):new F(null,this.children);{const t=R(e),i=this.children.get(t);if(i){const s=i.remove(L(e));let r;return s.isEmpty()?r=this.children.remove(t):r=this.children.insert(t,s),this.value===null&&r.isEmpty()?new F(null):new F(this.value,r)}else return this}}get(e){if(N(e))return this.value;{const t=R(e),i=this.children.get(t);return i?i.get(L(e)):null}}setTree(e,t){if(N(e))return t;{const i=R(e),r=(this.children.get(i)||new F(null)).setTree(L(e),t);let o;return r.isEmpty()?o=this.children.remove(i):o=this.children.insert(i,r),new F(this.value,o)}}fold(e){return this.fold_(k(),e)}fold_(e,t){const i={};return this.children.inorderTraversal((s,r)=>{i[s]=r.fold_(G(e,s),t)}),t(e,this.value,i)}findOnPath(e,t){return this.findOnPath_(e,k(),t)}findOnPath_(e,t,i){const s=this.value?i(t,this.value):!1;if(s)return s;if(N(e))return null;{const r=R(e),o=this.children.get(r);return o?o.findOnPath_(L(e),G(t,r),i):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,k(),t)}foreachOnPath_(e,t,i){if(N(e))return this;{this.value&&i(t,this.value);const s=R(e),r=this.children.get(s);return r?r.foreachOnPath_(L(e),G(t,s),i):new F(null)}}foreach(e){this.foreach_(k(),e)}foreach_(e,t){this.children.inorderTraversal((i,s)=>{s.foreach_(G(e,i),t)}),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal((t,i)=>{i.value&&e(t,i.value)})}}class ne{constructor(e){this.writeTree_=e}static empty(){return new ne(new F(null))}}function Ge(n,e,t){if(N(e))return new ne(new F(t));{const i=n.writeTree_.findRootMostValueAndPath(e);if(i!=null){const s=i.path;let r=i.value;const o=K(s,e);return r=r.updateChild(o,t),new ne(n.writeTree_.set(s,r))}else{const s=new F(t),r=n.writeTree_.setTree(e,s);return new ne(r)}}}function ui(n,e,t){let i=n;return X(t,(s,r)=>{i=Ge(i,G(e,s),r)}),i}function hi(n,e){if(N(e))return ne.empty();{const t=n.writeTree_.setTree(e,new F(null));return new ne(t)}}function en(n,e){return Ie(n,e)!=null}function Ie(n,e){const t=n.writeTree_.findRootMostValueAndPath(e);return t!=null?n.writeTree_.get(t.path).getChild(K(t.path,e)):null}function di(n){const e=[],t=n.writeTree_.value;return t!=null?t.isLeafNode()||t.forEachChild(B,(i,s)=>{e.push(new x(i,s))}):n.writeTree_.children.inorderTraversal((i,s)=>{s.value!=null&&e.push(new x(i,s.value))}),e}function ue(n,e){if(N(e))return n;{const t=Ie(n,e);return t!=null?new ne(new F(t)):new ne(n.writeTree_.subtree(e))}}function tn(n){return n.writeTree_.isEmpty()}function Ae(n,e){return us(k(),n.writeTree_,e)}function us(n,e,t){if(e.value!=null)return t.updateChild(n,e.value);{let i=null;return e.children.inorderTraversal((s,r)=>{s===".priority"?(m(r.value!==null,"Priority writes must always be leaf nodes"),i=r.value):t=us(G(n,s),r,t)}),!t.getChild(n).isEmpty()&&i!==null&&(t=t.updateChild(G(n,".priority"),i)),t}}function kt(n,e){return _s(e,n)}function cl(n,e,t,i,s){m(i>n.lastWriteId,"Stacking an older write on top of newer ones"),s===void 0&&(s=!0),n.allWrites.push({path:e,snap:t,writeId:i,visible:s}),s&&(n.visibleWrites=Ge(n.visibleWrites,e,t)),n.lastWriteId=i}function ul(n,e){for(let t=0;t<n.allWrites.length;t++){const i=n.allWrites[t];if(i.writeId===e)return i}return null}function hl(n,e){const t=n.allWrites.findIndex(l=>l.writeId===e);m(t>=0,"removeWrite called with nonexistent writeId.");const i=n.allWrites[t];n.allWrites.splice(t,1);let s=i.visible,r=!1,o=n.allWrites.length-1;for(;s&&o>=0;){const l=n.allWrites[o];l.visible&&(o>=t&&dl(l,i.path)?s=!1:ee(i.path,l.path)&&(r=!0)),o--}if(s){if(r)return fl(n),!0;if(i.snap)n.visibleWrites=hi(n.visibleWrites,i.path);else{const l=i.children;X(l,c=>{n.visibleWrites=hi(n.visibleWrites,G(i.path,c))})}return!0}else return!1}function dl(n,e){if(n.snap)return ee(n.path,e);for(const t in n.children)if(n.children.hasOwnProperty(t)&&ee(G(n.path,t),e))return!0;return!1}function fl(n){n.visibleWrites=hs(n.allWrites,_l,k()),n.allWrites.length>0?n.lastWriteId=n.allWrites[n.allWrites.length-1].writeId:n.lastWriteId=-1}function _l(n){return n.visible}function hs(n,e,t){let i=ne.empty();for(let s=0;s<n.length;++s){const r=n[s];if(e(r)){const o=r.path;let l;if(r.snap)ee(t,o)?(l=K(t,o),i=Ge(i,l,r.snap)):ee(o,t)&&(l=K(o,t),i=Ge(i,k(),r.snap.getChild(l)));else if(r.children){if(ee(t,o))l=K(t,o),i=ui(i,l,r.children);else if(ee(o,t))if(l=K(o,t),N(l))i=ui(i,k(),r.children);else{const c=Pe(r.children,R(l));if(c){const a=c.getChild(L(l));i=Ge(i,k(),a)}}}else throw nt("WriteRecord should have .snap or .children")}}return i}function ds(n,e,t,i,s){if(!i&&!s){const r=Ie(n.visibleWrites,e);if(r!=null)return r;{const o=ue(n.visibleWrites,e);if(tn(o))return t;if(t==null&&!en(o,k()))return null;{const l=t||I.EMPTY_NODE;return Ae(o,l)}}}else{const r=ue(n.visibleWrites,e);if(!s&&tn(r))return t;if(!s&&t==null&&!en(r,k()))return null;{const o=function(a){return(a.visible||s)&&(!i||!~i.indexOf(a.writeId))&&(ee(a.path,e)||ee(e,a.path))},l=hs(n.allWrites,o,e),c=t||I.EMPTY_NODE;return Ae(l,c)}}}function pl(n,e,t){let i=I.EMPTY_NODE;const s=Ie(n.visibleWrites,e);if(s)return s.isLeafNode()||s.forEachChild(B,(r,o)=>{i=i.updateImmediateChild(r,o)}),i;if(t){const r=ue(n.visibleWrites,e);return t.forEachChild(B,(o,l)=>{const c=Ae(ue(r,new M(o)),l);i=i.updateImmediateChild(o,c)}),di(r).forEach(o=>{i=i.updateImmediateChild(o.name,o.node)}),i}else{const r=ue(n.visibleWrites,e);return di(r).forEach(o=>{i=i.updateImmediateChild(o.name,o.node)}),i}}function gl(n,e,t,i,s){m(i||s,"Either existingEventSnap or existingServerSnap must exist");const r=G(e,t);if(en(n.visibleWrites,r))return null;{const o=ue(n.visibleWrites,r);return tn(o)?s.getChild(t):Ae(o,s.getChild(t))}}function ml(n,e,t,i){const s=G(e,t),r=Ie(n.visibleWrites,s);if(r!=null)return r;if(i.isCompleteForChild(t)){const o=ue(n.visibleWrites,s);return Ae(o,i.getNode().getImmediateChild(t))}else return null}function vl(n,e){return Ie(n.visibleWrites,e)}function yl(n,e,t,i,s,r,o){let l;const c=ue(n.visibleWrites,e),a=Ie(c,k());if(a!=null)l=a;else if(t!=null)l=Ae(c,t);else return[];if(l=l.withIndex(o),!l.isEmpty()&&!l.isLeafNode()){const u=[],d=o.getCompare(),_=r?l.getReverseIteratorFrom(i,o):l.getIteratorFrom(i,o);let f=_.getNext();for(;f&&u.length<s;)d(f,i)!==0&&u.push(f),f=_.getNext();return u}else return[]}function Cl(){return{visibleWrites:ne.empty(),allWrites:[],lastWriteId:-1}}function It(n,e,t,i){return ds(n.writeTree,n.treePath,e,t,i)}function En(n,e){return pl(n.writeTree,n.treePath,e)}function fi(n,e,t,i){return gl(n.writeTree,n.treePath,e,t,i)}function Tt(n,e){return vl(n.writeTree,G(n.treePath,e))}function El(n,e,t,i,s,r){return yl(n.writeTree,n.treePath,e,t,i,s,r)}function In(n,e,t){return ml(n.writeTree,n.treePath,e,t)}function fs(n,e){return _s(G(n.treePath,e),n.writeTree)}function _s(n,e){return{treePath:n,writeTree:e}}class Il{constructor(){this.changeMap=new Map}trackChildChange(e){const t=e.type,i=e.childName;m(t==="child_added"||t==="child_changed"||t==="child_removed","Only child changes supported for tracking"),m(i!==".priority","Only non-priority child changes can be tracked.");const s=this.changeMap.get(i);if(s){const r=s.type;if(t==="child_added"&&r==="child_removed")this.changeMap.set(i,Ke(i,e.snapshotNode,s.snapshotNode));else if(t==="child_removed"&&r==="child_added")this.changeMap.delete(i);else if(t==="child_removed"&&r==="child_changed")this.changeMap.set(i,je(i,s.oldSnap));else if(t==="child_changed"&&r==="child_added")this.changeMap.set(i,ke(i,e.snapshotNode));else if(t==="child_changed"&&r==="child_changed")this.changeMap.set(i,Ke(i,e.snapshotNode,s.oldSnap));else throw nt("Illegal combination of changes: "+e+" occurred after "+s)}else this.changeMap.set(i,e)}getChanges(){return Array.from(this.changeMap.values())}}class Tl{getCompleteChild(e){return null}getChildAfterChild(e,t,i){return null}}const ps=new Tl;class Tn{constructor(e,t,i=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=i}getCompleteChild(e){const t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{const i=this.optCompleteServerCache_!=null?new fe(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return In(this.writes_,e,i)}}getChildAfterChild(e,t,i){const s=this.optCompleteServerCache_!=null?this.optCompleteServerCache_:Ee(this.viewCache_),r=El(this.writes_,s,t,1,i,e);return r.length===0?null:r[0]}}function wl(n){return{filter:n}}function Sl(n,e){m(e.eventCache.getNode().isIndexed(n.filter.getIndex()),"Event snap not indexed"),m(e.serverCache.getNode().isIndexed(n.filter.getIndex()),"Server snap not indexed")}function bl(n,e,t,i,s){const r=new Il;let o,l;if(t.type===te.OVERWRITE){const a=t;a.source.fromUser?o=nn(n,e,a.path,a.snap,i,s,r):(m(a.source.fromServer,"Unknown source."),l=a.source.tagged||e.serverCache.isFiltered()&&!N(a.path),o=wt(n,e,a.path,a.snap,i,s,l,r))}else if(t.type===te.MERGE){const a=t;a.source.fromUser?o=Nl(n,e,a.path,a.children,i,s,r):(m(a.source.fromServer,"Unknown source."),l=a.source.tagged||e.serverCache.isFiltered(),o=sn(n,e,a.path,a.children,i,s,l,r))}else if(t.type===te.ACK_USER_WRITE){const a=t;a.revert?o=kl(n,e,a.path,i,s,r):o=Pl(n,e,a.path,a.affectedTree,i,s,r)}else if(t.type===te.LISTEN_COMPLETE)o=Rl(n,e,t.path,i,r);else throw nt("Unknown operation type: "+t.type);const c=r.getChanges();return xl(e,o,c),{viewCache:o,changes:c}}function xl(n,e,t){const i=e.eventCache;if(i.isFullyInitialized()){const s=i.getNode().isLeafNode()||i.getNode().isEmpty(),r=Et(n);(t.length>0||!n.eventCache.isFullyInitialized()||s&&!i.getNode().equals(r)||!i.getNode().getPriority().equals(r.getPriority()))&&t.push(os(Et(e)))}}function gs(n,e,t,i,s,r){const o=e.eventCache;if(Tt(i,t)!=null)return e;{let l,c;if(N(t))if(m(e.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),e.serverCache.isFiltered()){const a=Ee(e),u=a instanceof I?a:I.EMPTY_NODE,d=En(i,u);l=n.filter.updateFullNode(e.eventCache.getNode(),d,r)}else{const a=It(i,Ee(e));l=n.filter.updateFullNode(e.eventCache.getNode(),a,r)}else{const a=R(t);if(a===".priority"){m(de(t)===1,"Can't have a priority with additional path components");const u=o.getNode();c=e.serverCache.getNode();const d=fi(i,t,u,c);d!=null?l=n.filter.updatePriority(u,d):l=o.getNode()}else{const u=L(t);let d;if(o.isCompleteForChild(a)){c=e.serverCache.getNode();const _=fi(i,t,o.getNode(),c);_!=null?d=o.getNode().getImmediateChild(a).updateChild(u,_):d=o.getNode().getImmediateChild(a)}else d=In(i,a,e.serverCache);d!=null?l=n.filter.updateChild(o.getNode(),a,d,u,s,r):l=o.getNode()}}return Ve(e,l,o.isFullyInitialized()||N(t),n.filter.filtersNodes())}}function wt(n,e,t,i,s,r,o,l){const c=e.serverCache;let a;const u=o?n.filter:n.filter.getIndexedFilter();if(N(t))a=u.updateFullNode(c.getNode(),i,null);else if(u.filtersNodes()&&!c.isFiltered()){const f=c.getNode().updateChild(t,i);a=u.updateFullNode(c.getNode(),f,null)}else{const f=R(t);if(!c.isCompleteForPath(t)&&de(t)>1)return e;const h=L(t),g=c.getNode().getImmediateChild(f).updateChild(h,i);f===".priority"?a=u.updatePriority(c.getNode(),g):a=u.updateChild(c.getNode(),f,g,h,ps,null)}const d=cs(e,a,c.isFullyInitialized()||N(t),u.filtersNodes()),_=new Tn(s,d,r);return gs(n,d,t,s,_,l)}function nn(n,e,t,i,s,r,o){const l=e.eventCache;let c,a;const u=new Tn(s,e,r);if(N(t))a=n.filter.updateFullNode(e.eventCache.getNode(),i,o),c=Ve(e,a,!0,n.filter.filtersNodes());else{const d=R(t);if(d===".priority")a=n.filter.updatePriority(e.eventCache.getNode(),i),c=Ve(e,a,l.isFullyInitialized(),l.isFiltered());else{const _=L(t),f=l.getNode().getImmediateChild(d);let h;if(N(_))h=i;else{const p=u.getCompleteChild(d);p!=null?Qi(_)===".priority"&&p.getChild(Ji(_)).isEmpty()?h=p:h=p.updateChild(_,i):h=I.EMPTY_NODE}if(f.equals(h))c=e;else{const p=n.filter.updateChild(l.getNode(),d,h,_,u,o);c=Ve(e,p,l.isFullyInitialized(),n.filter.filtersNodes())}}}return c}function _i(n,e){return n.eventCache.isCompleteForChild(e)}function Nl(n,e,t,i,s,r,o){let l=e;return i.foreach((c,a)=>{const u=G(t,c);_i(e,R(u))&&(l=nn(n,l,u,a,s,r,o))}),i.foreach((c,a)=>{const u=G(t,c);_i(e,R(u))||(l=nn(n,l,u,a,s,r,o))}),l}function pi(n,e,t){return t.foreach((i,s)=>{e=e.updateChild(i,s)}),e}function sn(n,e,t,i,s,r,o,l){if(e.serverCache.getNode().isEmpty()&&!e.serverCache.isFullyInitialized())return e;let c=e,a;N(t)?a=i:a=new F(null).setTree(t,i);const u=e.serverCache.getNode();return a.children.inorderTraversal((d,_)=>{if(u.hasChild(d)){const f=e.serverCache.getNode().getImmediateChild(d),h=pi(n,f,_);c=wt(n,c,new M(d),h,s,r,o,l)}}),a.children.inorderTraversal((d,_)=>{const f=!e.serverCache.isCompleteForChild(d)&&_.value===null;if(!u.hasChild(d)&&!f){const h=e.serverCache.getNode().getImmediateChild(d),p=pi(n,h,_);c=wt(n,c,new M(d),p,s,r,o,l)}}),c}function Pl(n,e,t,i,s,r,o){if(Tt(s,t)!=null)return e;const l=e.serverCache.isFiltered(),c=e.serverCache;if(i.value!=null){if(N(t)&&c.isFullyInitialized()||c.isCompleteForPath(t))return wt(n,e,t,c.getNode().getChild(t),s,r,l,o);if(N(t)){let a=new F(null);return c.getNode().forEachChild(Ne,(u,d)=>{a=a.set(new M(u),d)}),sn(n,e,t,a,s,r,l,o)}else return e}else{let a=new F(null);return i.foreach((u,d)=>{const _=G(t,u);c.isCompleteForPath(_)&&(a=a.set(u,c.getNode().getChild(_)))}),sn(n,e,t,a,s,r,l,o)}}function Rl(n,e,t,i,s){const r=e.serverCache,o=cs(e,r.getNode(),r.isFullyInitialized()||N(t),r.isFiltered());return gs(n,o,t,i,ps,s)}function kl(n,e,t,i,s,r){let o;if(Tt(i,t)!=null)return e;{const l=new Tn(i,e,s),c=e.eventCache.getNode();let a;if(N(t)||R(t)===".priority"){let u;if(e.serverCache.isFullyInitialized())u=It(i,Ee(e));else{const d=e.serverCache.getNode();m(d instanceof I,"serverChildren would be complete if leaf node"),u=En(i,d)}u=u,a=n.filter.updateFullNode(c,u,r)}else{const u=R(t);let d=In(i,u,e.serverCache);d==null&&e.serverCache.isCompleteForChild(u)&&(d=c.getImmediateChild(u)),d!=null?a=n.filter.updateChild(c,u,d,L(t),l,r):e.eventCache.getNode().hasChild(u)?a=n.filter.updateChild(c,u,I.EMPTY_NODE,L(t),l,r):a=c,a.isEmpty()&&e.serverCache.isFullyInitialized()&&(o=It(i,Ee(e)),o.isLeafNode()&&(a=n.filter.updateFullNode(a,o,r)))}return o=e.serverCache.isFullyInitialized()||Tt(i,k())!=null,Ve(e,a,o,n.filter.filtersNodes())}}class Al{constructor(e,t){this.query_=e,this.eventRegistrations_=[];const i=this.query_._queryParams,s=new mn(i.getIndex()),r=Xo(i);this.processor_=wl(r);const o=t.serverCache,l=t.eventCache,c=s.updateFullNode(I.EMPTY_NODE,o.getNode(),null),a=r.updateFullNode(I.EMPTY_NODE,l.getNode(),null),u=new fe(c,o.isFullyInitialized(),s.filtersNodes()),d=new fe(a,l.isFullyInitialized(),r.filtersNodes());this.viewCache_=Rt(d,u),this.eventGenerator_=new sl(this.query_)}get query(){return this.query_}}function Ml(n){return n.viewCache_.serverCache.getNode()}function Ol(n){return Et(n.viewCache_)}function Ll(n,e){const t=Ee(n.viewCache_);return t&&(n.query._queryParams.loadsAllData()||!N(e)&&!t.getImmediateChild(R(e)).isEmpty())?t.getChild(e):null}function gi(n){return n.eventRegistrations_.length===0}function Dl(n,e){n.eventRegistrations_.push(e)}function mi(n,e,t){const i=[];if(t){m(e==null,"A cancel should cancel all event registrations.");const s=n.query._path;n.eventRegistrations_.forEach(r=>{const o=r.createCancelEvent(t,s);o&&i.push(o)})}if(e){let s=[];for(let r=0;r<n.eventRegistrations_.length;++r){const o=n.eventRegistrations_[r];if(!o.matches(e))s.push(o);else if(e.hasAnyCallback()){s=s.concat(n.eventRegistrations_.slice(r+1));break}}n.eventRegistrations_=s}else n.eventRegistrations_=[];return i}function vi(n,e,t,i){e.type===te.MERGE&&e.source.queryId!==null&&(m(Ee(n.viewCache_),"We should always have a full cache before handling merges"),m(Et(n.viewCache_),"Missing event cache, even though we have a server cache"));const s=n.viewCache_,r=bl(n.processor_,s,e,t,i);return Sl(n.processor_,r.viewCache),m(r.viewCache.serverCache.isFullyInitialized()||!s.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),n.viewCache_=r.viewCache,ms(n,r.changes,r.viewCache.eventCache.getNode(),null)}function Fl(n,e){const t=n.viewCache_.eventCache,i=[];return t.getNode().isLeafNode()||t.getNode().forEachChild(B,(r,o)=>{i.push(ke(r,o))}),t.isFullyInitialized()&&i.push(os(t.getNode())),ms(n,i,t.getNode(),e)}function ms(n,e,t,i){const s=i?[i]:n.eventRegistrations_;return rl(n.eventGenerator_,e,t,s)}let St;class vs{constructor(){this.views=new Map}}function Wl(n){m(!St,"__referenceConstructor has already been defined"),St=n}function Bl(){return m(St,"Reference.ts has not been loaded"),St}function Ul(n){return n.views.size===0}function wn(n,e,t,i){const s=e.source.queryId;if(s!==null){const r=n.views.get(s);return m(r!=null,"SyncTree gave us an op for an invalid query."),vi(r,e,t,i)}else{let r=[];for(const o of n.views.values())r=r.concat(vi(o,e,t,i));return r}}function ys(n,e,t,i,s){const r=e._queryIdentifier,o=n.views.get(r);if(!o){let l=It(t,s?i:null),c=!1;l?c=!0:i instanceof I?(l=En(t,i),c=!1):(l=I.EMPTY_NODE,c=!1);const a=Rt(new fe(l,c,!1),new fe(i,s,!1));return new Al(e,a)}return o}function Hl(n,e,t,i,s,r){const o=ys(n,e,i,s,r);return n.views.has(e._queryIdentifier)||n.views.set(e._queryIdentifier,o),Dl(o,t),Fl(o,t)}function Vl(n,e,t,i){const s=e._queryIdentifier,r=[];let o=[];const l=_e(n);if(s==="default")for(const[c,a]of n.views.entries())o=o.concat(mi(a,t,i)),gi(a)&&(n.views.delete(c),a.query._queryParams.loadsAllData()||r.push(a.query));else{const c=n.views.get(s);c&&(o=o.concat(mi(c,t,i)),gi(c)&&(n.views.delete(s),c.query._queryParams.loadsAllData()||r.push(c.query)))}return l&&!_e(n)&&r.push(new(Bl())(e._repo,e._path)),{removed:r,events:o}}function Cs(n){const e=[];for(const t of n.views.values())t.query._queryParams.loadsAllData()||e.push(t);return e}function he(n,e){let t=null;for(const i of n.views.values())t=t||Ll(i,e);return t}function Es(n,e){if(e._queryParams.loadsAllData())return At(n);{const i=e._queryIdentifier;return n.views.get(i)}}function Is(n,e){return Es(n,e)!=null}function _e(n){return At(n)!=null}function At(n){for(const e of n.views.values())if(e.query._queryParams.loadsAllData())return e;return null}let bt;function Gl(n){m(!bt,"__referenceConstructor has already been defined"),bt=n}function ql(){return m(bt,"Reference.ts has not been loaded"),bt}let zl=1;class yi{constructor(e){this.listenProvider_=e,this.syncPointTree_=new F(null),this.pendingWriteTree_=Cl(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}}function Ts(n,e,t,i,s){return cl(n.pendingWriteTree_,e,t,i,s),s?lt(n,new Ce(as(),e,t)):[]}function me(n,e,t=!1){const i=ul(n.pendingWriteTree_,e);if(hl(n.pendingWriteTree_,e)){let r=new F(null);return i.snap!=null?r=r.set(k(),!0):X(i.children,o=>{r=r.set(new M(o),!0)}),lt(n,new Ct(i.path,r,t))}else return[]}function ot(n,e,t){return lt(n,new Ce(yn(),e,t))}function Yl(n,e,t){const i=F.fromObject(t);return lt(n,new Xe(yn(),e,i))}function jl(n,e){return lt(n,new Qe(yn(),e))}function Kl(n,e,t){const i=bn(n,t);if(i){const s=xn(i),r=s.path,o=s.queryId,l=K(r,e),c=new Qe(Cn(o),l);return Nn(n,r,c)}else return[]}function ws(n,e,t,i,s=!1){const r=e._path,o=n.syncPointTree_.get(r);let l=[];if(o&&(e._queryIdentifier==="default"||Is(o,e))){const c=Vl(o,e,t,i);Ul(o)&&(n.syncPointTree_=n.syncPointTree_.remove(r));const a=c.removed;if(l=c.events,!s){const u=a.findIndex(_=>_._queryParams.loadsAllData())!==-1,d=n.syncPointTree_.findOnPath(r,(_,f)=>_e(f));if(u&&!d){const _=n.syncPointTree_.subtree(r);if(!_.isEmpty()){const f=Jl(_);for(let h=0;h<f.length;++h){const p=f[h],g=p.query,y=Ns(n,p);n.listenProvider_.startListening(qe(g),Je(n,g),y.hashFn,y.onComplete)}}}!d&&a.length>0&&!i&&(u?n.listenProvider_.stopListening(qe(e),null):a.forEach(_=>{const f=n.queryToTagMap.get(Mt(_));n.listenProvider_.stopListening(qe(_),f)}))}Zl(n,a)}return l}function Ss(n,e,t,i){const s=bn(n,i);if(s!=null){const r=xn(s),o=r.path,l=r.queryId,c=K(o,e),a=new Ce(Cn(l),c,t);return Nn(n,o,a)}else return[]}function $l(n,e,t,i){const s=bn(n,i);if(s){const r=xn(s),o=r.path,l=r.queryId,c=K(o,e),a=F.fromObject(t),u=new Xe(Cn(l),c,a);return Nn(n,o,u)}else return[]}function Ql(n,e,t,i=!1){const s=e._path;let r=null,o=!1;n.syncPointTree_.foreachOnPath(s,(_,f)=>{const h=K(_,s);r=r||he(f,h),o=o||_e(f)});let l=n.syncPointTree_.get(s);l?(o=o||_e(l),r=r||he(l,k())):(l=new vs,n.syncPointTree_=n.syncPointTree_.set(s,l));let c;r!=null?c=!0:(c=!1,r=I.EMPTY_NODE,n.syncPointTree_.subtree(s).foreachChild((f,h)=>{const p=he(h,k());p&&(r=r.updateImmediateChild(f,p))}));const a=Is(l,e);if(!a&&!e._queryParams.loadsAllData()){const _=Mt(e);m(!n.queryToTagMap.has(_),"View does not exist, but we have a tag");const f=ea();n.queryToTagMap.set(_,f),n.tagToQueryMap.set(f,_)}const u=kt(n.pendingWriteTree_,s);let d=Hl(l,e,t,u,r,c);if(!a&&!o&&!i){const _=Es(l,e);d=d.concat(ta(n,e,_))}return d}function Sn(n,e,t){const s=n.pendingWriteTree_,r=n.syncPointTree_.findOnPath(e,(o,l)=>{const c=K(o,e),a=he(l,c);if(a)return a});return ds(s,e,r,t,!0)}function Xl(n,e){const t=e._path;let i=null;n.syncPointTree_.foreachOnPath(t,(a,u)=>{const d=K(a,t);i=i||he(u,d)});let s=n.syncPointTree_.get(t);s?i=i||he(s,k()):(s=new vs,n.syncPointTree_=n.syncPointTree_.set(t,s));const r=i!=null,o=r?new fe(i,!0,!1):null,l=kt(n.pendingWriteTree_,e._path),c=ys(s,e,l,r?o.getNode():I.EMPTY_NODE,r);return Ol(c)}function lt(n,e){return bs(e,n.syncPointTree_,null,kt(n.pendingWriteTree_,k()))}function bs(n,e,t,i){if(N(n.path))return xs(n,e,t,i);{const s=e.get(k());t==null&&s!=null&&(t=he(s,k()));let r=[];const o=R(n.path),l=n.operationForChild(o),c=e.children.get(o);if(c&&l){const a=t?t.getImmediateChild(o):null,u=fs(i,o);r=r.concat(bs(l,c,a,u))}return s&&(r=r.concat(wn(s,n,i,t))),r}}function xs(n,e,t,i){const s=e.get(k());t==null&&s!=null&&(t=he(s,k()));let r=[];return e.children.inorderTraversal((o,l)=>{const c=t?t.getImmediateChild(o):null,a=fs(i,o),u=n.operationForChild(o);u&&(r=r.concat(xs(u,l,c,a)))}),s&&(r=r.concat(wn(s,n,i,t))),r}function Ns(n,e){const t=e.query,i=Je(n,t);return{hashFn:()=>(Ml(e)||I.EMPTY_NODE).hash(),onComplete:s=>{if(s==="ok")return i?Kl(n,t._path,i):jl(n,t._path);{const r=$r(s,t);return ws(n,t,null,r)}}}}function Je(n,e){const t=Mt(e);return n.queryToTagMap.get(t)}function Mt(n){return n._path.toString()+"$"+n._queryIdentifier}function bn(n,e){return n.tagToQueryMap.get(e)}function xn(n){const e=n.indexOf("$");return m(e!==-1&&e<n.length-1,"Bad queryKey."),{queryId:n.substr(e+1),path:new M(n.substr(0,e))}}function Nn(n,e,t){const i=n.syncPointTree_.get(e);m(i,"Missing sync point for query tag that we're tracking");const s=kt(n.pendingWriteTree_,e);return wn(i,t,s,null)}function Jl(n){return n.fold((e,t,i)=>{if(t&&_e(t))return[At(t)];{let s=[];return t&&(s=Cs(t)),X(i,(r,o)=>{s=s.concat(o)}),s}})}function qe(n){return n._queryParams.loadsAllData()&&!n._queryParams.isDefault()?new(ql())(n._repo,n._path):n}function Zl(n,e){for(let t=0;t<e.length;++t){const i=e[t];if(!i._queryParams.loadsAllData()){const s=Mt(i),r=n.queryToTagMap.get(s);n.queryToTagMap.delete(s),n.tagToQueryMap.delete(r)}}}function ea(){return zl++}function ta(n,e,t){const i=e._path,s=Je(n,e),r=Ns(n,t),o=n.listenProvider_.startListening(qe(e),s,r.hashFn,r.onComplete),l=n.syncPointTree_.subtree(i);if(s)m(!_e(l.value),"If we're adding a query, it shouldn't be shadowed");else{const c=l.fold((a,u,d)=>{if(!N(a)&&u&&_e(u))return[At(u).query];{let _=[];return u&&(_=_.concat(Cs(u).map(f=>f.query))),X(d,(f,h)=>{_=_.concat(h)}),_}});for(let a=0;a<c.length;++a){const u=c[a];n.listenProvider_.stopListening(qe(u),Je(n,u))}}return o}class Pn{constructor(e){this.node_=e}getImmediateChild(e){const t=this.node_.getImmediateChild(e);return new Pn(t)}node(){return this.node_}}class Rn{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(e){const t=G(this.path_,e);return new Rn(this.syncTree_,t)}node(){return Sn(this.syncTree_,this.path_)}}const na=function(n){return n=n||{},n.timestamp=n.timestamp||new Date().getTime(),n},Ci=function(n,e,t){if(!n||typeof n!="object")return n;if(m(".sv"in n,"Unexpected leaf node or priority contents"),typeof n[".sv"]=="string")return ia(n[".sv"],e,t);if(typeof n[".sv"]=="object")return sa(n[".sv"],e);m(!1,"Unexpected server value: "+JSON.stringify(n,null,2))},ia=function(n,e,t){switch(n){case"timestamp":return t.timestamp;default:m(!1,"Unexpected server value: "+n)}},sa=function(n,e,t){n.hasOwnProperty("increment")||m(!1,"Unexpected server value: "+JSON.stringify(n,null,2));const i=n.increment;typeof i!="number"&&m(!1,"Unexpected increment value: "+i);const s=e.node();if(m(s!==null&&typeof s<"u","Expected ChildrenNode.EMPTY_NODE for nulls"),!s.isLeafNode())return i;const o=s.getValue();return typeof o!="number"?i:o+i},ra=function(n,e,t,i){return kn(e,new Rn(t,n),i)},Ps=function(n,e,t){return kn(n,new Pn(e),t)};function kn(n,e,t){const i=n.getPriority().val(),s=Ci(i,e.getImmediateChild(".priority"),t);let r;if(n.isLeafNode()){const o=n,l=Ci(o.getValue(),e,t);return l!==o.getValue()||s!==o.getPriority().val()?new q(l,Y(s)):n}else{const o=n;return r=o,s!==o.getPriority().val()&&(r=r.updatePriority(new q(s))),o.forEachChild(B,(l,c)=>{const a=kn(c,e.getImmediateChild(l),t);a!==c&&(r=r.updateImmediateChild(l,a))}),r}}class An{constructor(e="",t=null,i={children:{},childCount:0}){this.name=e,this.parent=t,this.node=i}}function Mn(n,e){let t=e instanceof M?e:new M(e),i=n,s=R(t);for(;s!==null;){const r=Pe(i.node.children,s)||{children:{},childCount:0};i=new An(s,i,r),t=L(t),s=R(t)}return i}function De(n){return n.node.value}function Rs(n,e){n.node.value=e,rn(n)}function ks(n){return n.node.childCount>0}function oa(n){return De(n)===void 0&&!ks(n)}function Ot(n,e){X(n.node.children,(t,i)=>{e(new An(t,n,i))})}function As(n,e,t,i){t&&!i&&e(n),Ot(n,s=>{As(s,e,!0,i)}),t&&i&&e(n)}function la(n,e,t){let i=t?n:n.parent;for(;i!==null;){if(e(i))return!0;i=i.parent}return!1}function at(n){return new M(n.parent===null?n.name:at(n.parent)+"/"+n.name)}function rn(n){n.parent!==null&&aa(n.parent,n.name,n)}function aa(n,e,t){const i=oa(t),s=le(n.node.children,e);i&&s?(delete n.node.children[e],n.node.childCount--,rn(n)):!i&&!s&&(n.node.children[e]=t.node,n.node.childCount++,rn(n))}const ca=/[\[\].#$\/\u0000-\u001F\u007F]/,ua=/[\[\].#$\u0000-\u001F\u007F]/,qt=10*1024*1024,Ms=function(n){return typeof n=="string"&&n.length!==0&&!ca.test(n)},Os=function(n){return typeof n=="string"&&n.length!==0&&!ua.test(n)},ha=function(n){return n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),Os(n)},da=function(n,e,t,i){i&&e===void 0||On(cn(n,"value"),e,t)},On=function(n,e,t){const i=t instanceof M?new Po(t,n):t;if(e===void 0)throw new Error(n+"contains undefined "+pe(i));if(typeof e=="function")throw new Error(n+"contains a function "+pe(i)+" with contents = "+e.toString());if(Pi(e))throw new Error(n+"contains "+e.toString()+" "+pe(i));if(typeof e=="string"&&e.length>qt/3&&Nt(e)>qt)throw new Error(n+"contains a string greater than "+qt+" utf8 bytes "+pe(i)+" ('"+e.substring(0,50)+"...')");if(e&&typeof e=="object"){let s=!1,r=!1;if(X(e,(o,l)=>{if(o===".value")s=!0;else if(o!==".priority"&&o!==".sv"&&(r=!0,!Ms(o)))throw new Error(n+" contains an invalid key ("+o+") "+pe(i)+`.  Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`);Ro(i,o),On(n,l,i),ko(i)}),s&&r)throw new Error(n+' contains ".value" child '+pe(i)+" in addition to actual children.")}},Ls=function(n,e,t,i){if(!(i&&t===void 0)&&!Os(t))throw new Error(cn(n,e)+'was an invalid path = "'+t+`". Paths must be non-empty strings and can't contain ".", "#", "$", "[", or "]"`)},fa=function(n,e,t,i){t&&(t=t.replace(/^\/*\.info(\/|$)/,"/")),Ls(n,e,t,i)},Ds=function(n,e){if(R(e)===".info")throw new Error(n+" failed = Can't modify data under /.info/")},_a=function(n,e){const t=e.path.toString();if(typeof e.repoInfo.host!="string"||e.repoInfo.host.length===0||!Ms(e.repoInfo.namespace)&&e.repoInfo.host.split(":")[0]!=="localhost"||t.length!==0&&!ha(t))throw new Error(cn(n,"url")+`must be a valid firebase URL and the path can't contain ".", "#", "$", "[", or "]".`)};class pa{constructor(){this.eventLists_=[],this.recursionDepth_=0}}function Fs(n,e){let t=null;for(let i=0;i<e.length;i++){const s=e[i],r=s.getPath();t!==null&&!Zi(r,t.path)&&(n.eventLists_.push(t),t=null),t===null&&(t={events:[],path:r}),t.events.push(s)}t&&n.eventLists_.push(t)}function ie(n,e,t){Fs(n,t),ga(n,i=>ee(i,e)||ee(e,i))}function ga(n,e){n.recursionDepth_++;let t=!0;for(let i=0;i<n.eventLists_.length;i++){const s=n.eventLists_[i];if(s){const r=s.path;e(r)?(ma(n.eventLists_[i]),n.eventLists_[i]=null):t=!1}}t&&(n.eventLists_=[]),n.recursionDepth_--}function ma(n){for(let e=0;e<n.events.length;e++){const t=n.events[e];if(t!==null){n.events[e]=null;const i=t.getEventRunner();ve&&j("event: "+t.toString()),Le(i)}}}const va="repo_interrupt",ya=25;class Ca{constructor(e,t,i,s){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=i,this.appCheckProvider_=s,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new pa,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=yt(),this.transactionQueueTree_=new An,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}}function Ea(n,e,t){if(n.stats_=fn(n.repoInfo_),n.forceRestClient_||Zr())n.server_=new vt(n.repoInfo_,(i,s,r,o)=>{Ei(n,i,s,r,o)},n.authTokenProvider_,n.appCheckProvider_),setTimeout(()=>Ii(n,!0),0);else{if(typeof t<"u"&&t!==null){if(typeof t!="object")throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{V(t)}catch(i){throw new Error("Invalid authOverride provided: "+i)}}n.persistentConnection_=new re(n.repoInfo_,e,(i,s,r,o)=>{Ei(n,i,s,r,o)},i=>{Ii(n,i)},i=>{Ta(n,i)},n.authTokenProvider_,n.appCheckProvider_,t),n.server_=n.persistentConnection_}n.authTokenProvider_.addTokenChangeListener(i=>{n.server_.refreshAuthToken(i)}),n.appCheckProvider_.addTokenChangeListener(i=>{n.server_.refreshAppCheckToken(i.token)}),n.statsReporter_=so(n.repoInfo_,()=>new il(n.stats_,n.server_)),n.infoData_=new Jo,n.infoSyncTree_=new yi({startListening:(i,s,r,o)=>{let l=[];const c=n.infoData_.getNode(i._path);return c.isEmpty()||(l=ot(n.infoSyncTree_,i._path,c),setTimeout(()=>{o("ok")},0)),l},stopListening:()=>{}}),Dn(n,"connected",!1),n.serverSyncTree_=new yi({startListening:(i,s,r,o)=>(n.server_.listen(i,r,s,(l,c)=>{const a=o(l,c);ie(n.eventQueue_,i._path,a)}),[]),stopListening:(i,s)=>{n.server_.unlisten(i,s)}})}function Ia(n){const t=n.infoData_.getNode(new M(".info/serverTimeOffset")).val()||0;return new Date().getTime()+t}function Ln(n){return na({timestamp:Ia(n)})}function Ei(n,e,t,i,s){n.dataUpdateCount++;const r=new M(e);t=n.interceptServerDataCallback_?n.interceptServerDataCallback_(e,t):t;let o=[];if(s)if(i){const c=_t(t,a=>Y(a));o=$l(n.serverSyncTree_,r,c,s)}else{const c=Y(t);o=Ss(n.serverSyncTree_,r,c,s)}else if(i){const c=_t(t,a=>Y(a));o=Yl(n.serverSyncTree_,r,c)}else{const c=Y(t);o=ot(n.serverSyncTree_,r,c)}let l=r;o.length>0&&(l=Dt(n,r)),ie(n.eventQueue_,l,o)}function Ii(n,e){Dn(n,"connected",e),e===!1&&ba(n)}function Ta(n,e){X(e,(t,i)=>{Dn(n,t,i)})}function Dn(n,e,t){const i=new M("/.info/"+e),s=Y(t);n.infoData_.updateSnapshot(i,s);const r=ot(n.infoSyncTree_,i,s);ie(n.eventQueue_,i,r)}function Ws(n){return n.nextWriteId_++}function wa(n,e,t){const i=Xl(n.serverSyncTree_,e);return i!=null?Promise.resolve(i):n.server_.get(e).then(s=>{const r=Y(s).withIndex(e._queryParams.getIndex());Ql(n.serverSyncTree_,e,t,!0);let o;if(e._queryParams.loadsAllData())o=ot(n.serverSyncTree_,e._path,r);else{const l=Je(n.serverSyncTree_,e);o=Ss(n.serverSyncTree_,e._path,r,l)}return ie(n.eventQueue_,e._path,o),ws(n.serverSyncTree_,e,t,null,!0),r},s=>(Lt(n,"get for query "+V(e)+" failed: "+s),Promise.reject(new Error(s))))}function Sa(n,e,t,i,s){Lt(n,"set",{path:e.toString(),value:t,priority:i});const r=Ln(n),o=Y(t,i),l=Sn(n.serverSyncTree_,e),c=Ps(o,l,r),a=Ws(n),u=Ts(n.serverSyncTree_,e,c,a,!0);Fs(n.eventQueue_,u),n.server_.put(e.toString(),o.val(!0),(_,f)=>{const h=_==="ok";h||Q("set at "+e+" failed: "+_);const p=me(n.serverSyncTree_,a,!h);ie(n.eventQueue_,e,p),Na(n,s,_,f)});const d=Gs(n,e);Dt(n,d),ie(n.eventQueue_,d,[])}function ba(n){Lt(n,"onDisconnectEvents");const e=Ln(n),t=yt();Zt(n.onDisconnect_,k(),(s,r)=>{const o=ra(s,r,n.serverSyncTree_,e);ls(t,s,o)});let i=[];Zt(t,k(),(s,r)=>{i=i.concat(ot(n.serverSyncTree_,s,r));const o=Gs(n,s);Dt(n,o)}),n.onDisconnect_=yt(),ie(n.eventQueue_,k(),i)}function xa(n){n.persistentConnection_&&n.persistentConnection_.interrupt(va)}function Lt(n,...e){let t="";n.persistentConnection_&&(t=n.persistentConnection_.id+":"),j(t,...e)}function Na(n,e,t,i){e&&Le(()=>{if(t==="ok")e(null);else{const s=(t||"error").toUpperCase();let r=s;i&&(r+=": "+i);const o=new Error(r);o.code=s,e(o)}})}function Bs(n,e,t){return Sn(n.serverSyncTree_,e,t)||I.EMPTY_NODE}function Fn(n,e=n.transactionQueueTree_){if(e||Ft(n,e),De(e)){const t=Hs(n,e);m(t.length>0,"Sending zero length transaction queue"),t.every(s=>s.status===0)&&Pa(n,at(e),t)}else ks(e)&&Ot(e,t=>{Fn(n,t)})}function Pa(n,e,t){const i=t.map(a=>a.currentWriteId),s=Bs(n,e,i);let r=s;const o=s.hash();for(let a=0;a<t.length;a++){const u=t[a];m(u.status===0,"tryToSendTransactionQueue_: items in queue should all be run."),u.status=1,u.retryCount++;const d=K(e,u.path);r=r.updateChild(d,u.currentOutputSnapshotRaw)}const l=r.val(!0),c=e;n.server_.put(c.toString(),l,a=>{Lt(n,"transaction put response",{path:c.toString(),status:a});let u=[];if(a==="ok"){const d=[];for(let _=0;_<t.length;_++)t[_].status=2,u=u.concat(me(n.serverSyncTree_,t[_].currentWriteId)),t[_].onComplete&&d.push(()=>t[_].onComplete(null,!0,t[_].currentOutputSnapshotResolved)),t[_].unwatcher();Ft(n,Mn(n.transactionQueueTree_,e)),Fn(n,n.transactionQueueTree_),ie(n.eventQueue_,e,u);for(let _=0;_<d.length;_++)Le(d[_])}else{if(a==="datastale")for(let d=0;d<t.length;d++)t[d].status===3?t[d].status=4:t[d].status=0;else{Q("transaction at "+c.toString()+" failed: "+a);for(let d=0;d<t.length;d++)t[d].status=4,t[d].abortReason=a}Dt(n,e)}},o)}function Dt(n,e){const t=Us(n,e),i=at(t),s=Hs(n,t);return Ra(n,s,i),i}function Ra(n,e,t){if(e.length===0)return;const i=[];let s=[];const o=e.filter(l=>l.status===0).map(l=>l.currentWriteId);for(let l=0;l<e.length;l++){const c=e[l],a=K(t,c.path);let u=!1,d;if(m(a!==null,"rerunTransactionsUnderNode_: relativePath should not be null."),c.status===4)u=!0,d=c.abortReason,s=s.concat(me(n.serverSyncTree_,c.currentWriteId,!0));else if(c.status===0)if(c.retryCount>=ya)u=!0,d="maxretry",s=s.concat(me(n.serverSyncTree_,c.currentWriteId,!0));else{const _=Bs(n,c.path,o);c.currentInputSnapshot=_;const f=e[l].update(_.val());if(f!==void 0){On("transaction failed: Data returned ",f,c.path);let h=Y(f);typeof f=="object"&&f!=null&&le(f,".priority")||(h=h.updatePriority(_.getPriority()));const g=c.currentWriteId,y=Ln(n),T=Ps(h,_,y);c.currentOutputSnapshotRaw=h,c.currentOutputSnapshotResolved=T,c.currentWriteId=Ws(n),o.splice(o.indexOf(g),1),s=s.concat(Ts(n.serverSyncTree_,c.path,T,c.currentWriteId,c.applyLocally)),s=s.concat(me(n.serverSyncTree_,g,!0))}else u=!0,d="nodata",s=s.concat(me(n.serverSyncTree_,c.currentWriteId,!0))}ie(n.eventQueue_,t,s),s=[],u&&(e[l].status=2,function(_){setTimeout(_,Math.floor(0))}(e[l].unwatcher),e[l].onComplete&&(d==="nodata"?i.push(()=>e[l].onComplete(null,!1,e[l].currentInputSnapshot)):i.push(()=>e[l].onComplete(new Error(d),!1,null))))}Ft(n,n.transactionQueueTree_);for(let l=0;l<i.length;l++)Le(i[l]);Fn(n,n.transactionQueueTree_)}function Us(n,e){let t,i=n.transactionQueueTree_;for(t=R(e);t!==null&&De(i)===void 0;)i=Mn(i,t),e=L(e),t=R(e);return i}function Hs(n,e){const t=[];return Vs(n,e,t),t.sort((i,s)=>i.order-s.order),t}function Vs(n,e,t){const i=De(e);if(i)for(let s=0;s<i.length;s++)t.push(i[s]);Ot(e,s=>{Vs(n,s,t)})}function Ft(n,e){const t=De(e);if(t){let i=0;for(let s=0;s<t.length;s++)t[s].status!==2&&(t[i]=t[s],i++);t.length=i,Rs(e,t.length>0?t:void 0)}Ot(e,i=>{Ft(n,i)})}function Gs(n,e){const t=at(Us(n,e)),i=Mn(n.transactionQueueTree_,e);return la(i,s=>{zt(n,s)}),zt(n,i),As(i,s=>{zt(n,s)}),t}function zt(n,e){const t=De(e);if(t){const i=[];let s=[],r=-1;for(let o=0;o<t.length;o++)t[o].status===3||(t[o].status===1?(m(r===o-1,"All SENT items should be at beginning of queue."),r=o,t[o].status=3,t[o].abortReason="set"):(m(t[o].status===0,"Unexpected transaction status in abort"),t[o].unwatcher(),s=s.concat(me(n.serverSyncTree_,t[o].currentWriteId,!0)),t[o].onComplete&&i.push(t[o].onComplete.bind(null,new Error("set"),!1,null))));r===-1?Rs(e,void 0):t.length=r+1,ie(n.eventQueue_,at(e),s);for(let o=0;o<i.length;o++)Le(i[o])}}function ka(n){let e="";const t=n.split("/");for(let i=0;i<t.length;i++)if(t[i].length>0){let s=t[i];try{s=decodeURIComponent(s.replace(/\+/g," "))}catch{}e+="/"+s}return e}function Aa(n){const e={};n.charAt(0)==="?"&&(n=n.substring(1));for(const t of n.split("&")){if(t.length===0)continue;const i=t.split("=");i.length===2?e[decodeURIComponent(i[0])]=decodeURIComponent(i[1]):Q(`Invalid query segment '${t}' in query '${n}'`)}return e}const Ti=function(n,e){const t=Ma(n),i=t.namespace;t.domain==="firebase.com"&&oe(t.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),(!i||i==="undefined")&&t.domain!=="localhost"&&oe("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),t.secure||qr();const s=t.scheme==="ws"||t.scheme==="wss";return{repoInfo:new Hi(t.host,t.secure,i,s,e,"",i!==t.subdomain),path:new M(t.pathString)}},Ma=function(n){let e="",t="",i="",s="",r="",o=!0,l="https",c=443;if(typeof n=="string"){let a=n.indexOf("//");a>=0&&(l=n.substring(0,a-1),n=n.substring(a+2));let u=n.indexOf("/");u===-1&&(u=n.length);let d=n.indexOf("?");d===-1&&(d=n.length),e=n.substring(0,Math.min(u,d)),u<d&&(s=ka(n.substring(u,d)));const _=Aa(n.substring(Math.min(n.length,d)));a=e.indexOf(":"),a>=0?(o=l==="https"||l==="wss",c=parseInt(e.substring(a+1),10)):a=e.length;const f=e.slice(0,a);if(f.toLowerCase()==="localhost")t="localhost";else if(f.split(".").length<=2)t=f;else{const h=e.indexOf(".");i=e.substring(0,h).toLowerCase(),t=e.substring(h+1),r=i}"ns"in _&&(r=_.ns)}return{host:e,port:c,domain:t,subdomain:i,secure:o,scheme:l,pathString:s,namespace:r}};class Oa{constructor(e,t,i,s){this.eventType=e,this.eventRegistration=t,this.snapshot=i,this.prevName=s}getPath(){const e=this.snapshot.ref;return this.eventType==="value"?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+V(this.snapshot.exportVal())}}class La{constructor(e,t,i){this.eventRegistration=e,this.error=t,this.path=i}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}}class Da{constructor(e,t){this.snapshotCallback=e,this.cancelCallback=t}onValue(e,t){this.snapshotCallback.call(null,e,t)}onCancel(e){return m(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||this.snapshotCallback.userCallback!==void 0&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}}class Wn{constructor(e,t,i,s){this._repo=e,this._path=t,this._queryParams=i,this._orderByCalled=s}get key(){return N(this._path)?null:Qi(this._path)}get ref(){return new ae(this._repo,this._path)}get _queryIdentifier(){const e=ai(this._queryParams),t=hn(e);return t==="{}"?"default":t}get _queryObject(){return ai(this._queryParams)}isEqual(e){if(e=Me(e),!(e instanceof Wn))return!1;const t=this._repo===e._repo,i=Zi(this._path,e._path),s=this._queryIdentifier===e._queryIdentifier;return t&&i&&s}toJSON(){return this.toString()}toString(){return this._repo.toString()+No(this._path)}}class ae extends Wn{constructor(e,t){super(e,t,new vn,!1)}get parent(){const e=Ji(this._path);return e===null?null:new ae(this._repo,e)}get root(){let e=this;for(;e.parent!==null;)e=e.parent;return e}}class Ze{constructor(e,t,i){this._node=e,this.ref=t,this._index=i}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(e){const t=new M(e),i=xt(this.ref,e);return new Ze(this._node.getChild(t),i,B)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(e){return this._node.isLeafNode()?!1:!!this._node.forEachChild(this._index,(i,s)=>e(new Ze(s,xt(this.ref,i),B)))}hasChild(e){const t=new M(e);return!this._node.getChild(t).isEmpty()}hasChildren(){return this._node.isLeafNode()?!1:!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}}function Fa(n,e){return n=Me(n),n._checkNotDeleted("ref"),e!==void 0?xt(n._root,e):n._root}function xt(n,e){return n=Me(n),R(n._path)===null?fa("child","path",e,!1):Ls("child","path",e,!1),new ae(n._repo,G(n._path,e))}function Wa(n){return Ds("remove",n._path),Ba(n,null)}function Ba(n,e){n=Me(n),Ds("set",n._path),da("set",e,n._path,!1);const t=new un;return Sa(n._repo,n._path,e,null,t.wrapCallback(()=>{})),t.promise}function Ua(n){n=Me(n);const e=new Da(()=>{}),t=new Bn(e);return wa(n._repo,n,t).then(i=>new Ze(i,new ae(n._repo,n._path),n._queryParams.getIndex()))}class Bn{constructor(e){this.callbackContext=e}respondsTo(e){return e==="value"}createEvent(e,t){const i=t._queryParams.getIndex();return new Oa("value",this,new Ze(e.snapshotNode,new ae(t._repo,t._path),i))}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new La(this,e,t):null}matches(e){return e instanceof Bn?!e.callbackContext||!this.callbackContext?!0:e.callbackContext.matches(this.callbackContext):!1}hasAnyCallback(){return this.callbackContext!==null}}Wl(ae);Gl(ae);const Ha="FIREBASE_DATABASE_EMULATOR_HOST",on={};let Va=!1;function Ga(n,e,t,i){n.repoInfo_=new Hi(`${e}:${t}`,!1,n.repoInfo_.namespace,n.repoInfo_.webSocketOnly,n.repoInfo_.nodeAdmin,n.repoInfo_.persistenceKey,n.repoInfo_.includeNamespaceInQueryParams,!0),i&&(n.authTokenProvider_=i)}function qa(n,e,t,i,s){let r=i||n.options.databaseURL;r===void 0&&(n.options.projectId||oe("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),j("Using default host for project ",n.options.projectId),r=`${n.options.projectId}-default-rtdb.firebaseio.com`);let o=Ti(r,s),l=o.repoInfo,c,a;typeof process<"u"&&process.env&&(a=process.env[Ha]),a?(c=!0,r=`http://${a}?ns=${l.namespace}`,o=Ti(r,s),l=o.repoInfo):c=!o.repoInfo.secure;const u=s&&c?new xe(xe.OWNER):new to(n.name,n.options,e);_a("Invalid Firebase Database URL",o),N(o.path)||oe("Database URL must point to the root of a Firebase Database (not including a child path).");const d=Ya(l,n,u,new eo(n.name,t));return new ja(d,n)}function za(n,e){const t=on[e];(!t||t[n.key]!==n)&&oe(`Database ${e}(${n.repoInfo_}) has already been deleted.`),xa(n),delete t[n.key]}function Ya(n,e,t,i){let s=on[e.name];s||(s={},on[e.name]=s);let r=s[n.toURLString()];return r&&oe("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),r=new Ca(n,Va,t,i),s[n.toURLString()]=r,r}class ja{constructor(e,t){this._repoInternal=e,this.app=t,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(Ea(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new ae(this._repo,k())),this._rootInternal}_delete(){return this._rootInternal!==null&&(za(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){this._rootInternal===null&&oe("Cannot call "+e+" on a deleted database.")}}function Ka(n=Zs(),e){const t=Xs(n,"database").getImmediate({identifier:e});if(!t._instanceStarted){const i=Js("database");i&&$a(t,...i)}return t}function $a(n,e,t,i={}){n=Me(n),n._checkNotDeleted("useEmulator"),n._instanceStarted&&oe("Cannot call useEmulator() after instance has already been initialized.");const s=n._repoInternal;let r;if(s.repoInfo_.nodeAdmin)i.mockUserToken&&oe('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),r=new xe(xe.OWNER);else if(i.mockUserToken){const o=typeof i.mockUserToken=="string"?i.mockUserToken:er(i.mockUserToken,n.app.options.projectId);r=new xe(o)}Ga(s,e,t,r)}function Qa(n){Br(fr),tr(new nr("database",(e,{instanceIdentifier:t})=>{const i=e.getProvider("app").getImmediate(),s=e.getProvider("auth-internal"),r=e.getProvider("app-check-internal");return qa(i,s,r,t)},"PUBLIC").setMultipleInstances(!0)),Un(zn,Yn,n),Un(zn,Yn,"esm2017")}re.prototype.simpleListen=function(n,e){this.sendRequest("q",{p:n},e)};re.prototype.echo=function(n,e){this.sendRequest("echo",{d:n},e)};Qa();const Xa=pr(),Ja=Ka();async function Za(n){try{const e=Fa(Ja,`users/${Xa.user.uid}/list`),t=await Ua(e),i=[];t.forEach(s=>{if(s.child("_id").val()===n){const r=xt(e,`${s.key}`),o=Wa(r);i.push(o)}}),await Promise.all(i),Vn.Notify.success("Books were deleted."),console.log("Books were deleted")}catch(e){throw Vn.Notify.success("Error removing books!"),console.error("Error removing books:",e),e}}function ec(n){return n.map(tc).join("")}function tc(n){const{_id:e,list_name:t,author:i,description:s,title:r,book_image:o,buy_links:l}=n;return`
    <li class="shoppinglist-item">
      ${nc(e)}
      <div class="shoppinglist-thumb">
        <img src="${o}" alt="${r}" class="shoppinglist-img" />
      </div>
      <div class="shoppinglist-info-book">
        <h3 class="shoppinglist-name-book">${r}</h3>
        <p class="shoppinglist-book-category">${t}</p>
        <p class="shoppinglist-book-text">${s}</p>
        <div class="shoppinglist-author-link-wrap">
          <p class="shoppinglist-name-author">${i}</p>
          ${ic(l)}
        </div>
      </div>
    </li>
  `}function nc(n){return`
    <button type="button" data-book-id="${n}" class="shoppinglist-delete-book-button">
      <svg data-book-id="${n}" 
        class="shoppinglist-delete-book-button-svg"
        xmlns="http://www.w3.org/2000/svg"
        width="18"
        height="18"
        viewBox="0 0 18 18"
        fill="none"
      >
        <path
          d="M6.75 2.25H11.25M2.25 4.5H15.75M14.25 4.5L13.724 12.3895C13.6451 13.5732 13.6057 14.165 13.35 14.6138C13.1249 15.0088 12.7854 15.3265 12.3762 15.5248C11.9115 15.75 11.3183 15.75 10.132 15.75H7.86799C6.68168 15.75 6.08852 15.75 5.62375 15.5248C5.21457 15.3265 4.87507 15.0088 4.64999 14.6138C4.39433 14.165 4.35488 13.5732 4.27596 12.3895L3.75 4.5M7.5 7.875V11.625M10.5 7.875V11.625"
          stroke="white"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
    </button>
  `}function ic(n){const e="../../img/shoppingList-sprite.svg";return`
    <ul class="shoppinglist-link-wrap">
      ${Yt(n[0].url,e,"shoppinglist-book-link-svg-cont-amazon","icon-Amazon")}
      ${Yt(n[1].url,e,"shoppinglist-book-link-svg-cont","icon-apple-books")}
      ${Yt(n[2].url,e,"shoppinglist-book-link-svg-cont","icon-book-shop")}
    </ul>
  `}function Yt(n,e,t,i){return`
    <li>
      <a href="${n}" target="_blank" class="shoppinglist-book-link">
        <svg class="${t}">
          <use class="shoppinglist-book-link-svg" href="${e}#${i}"></use>
        </svg>
      </a>
    </li>
  `}let et=[],ze,ln,tt,sc=window.matchMedia("(max-width: 767px)");async function rc(n){n.preventDefault();const t=n.target.dataset.bookId;t&&(await Za(t),console.log("bookId: ",t),et=et.filter(i=>i._id!==t)),qs()}function qs(){const n=cc(et),e=yr(n,ln);Cr(e,n,zs),uc(n[0])}function oc(){tt.innerHTML=lc(),console.log("booksContainer: ",tt)}function lc(){return`
  <div class="shopping_list-placeholder-container">
    <p class="shopping_list-placeholder-text">This page is empty, add some books and proceed to order.</p>
    <div class="shopping_list-placeholder-thumb"></div>
  </div>`}function ac(){if(et.length===0||Array.isArray(et)===!1){oc();return}sc.matches?(ze=4,ln=2):(ze=3,ln=3),qs()}function cc(n){const e=[],t=Math.ceil(n.length/ze);for(let i=0;i<t;i++){const s=i*ze,r=n.slice(s,s+ze);e.push(r)}return console.log("paginatedItems: ",e),e}function zs(n){const e=ec(n);tt.insertAdjacentHTML("beforeend",e)}function uc(n){tt.innerHTML="",zs(n),tt.addEventListener("click",function(e){const t=e.target;(t.classList.contains("shoppinglist-delete-book-button")||t.classList.contains("shoppinglist-delete-book-button-svg"))&&rc(e)})}window.addEventListener("resize",Wr(ac,200));
